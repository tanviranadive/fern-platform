<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fern Platform - Modern Test Intelligence</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/web/js/graphql-client.js?v=2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="/web/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Fallback CSS for when FontAwesome doesn't load -->
    <style>
        /* Icon fallbacks using Unicode symbols */
        .icon-fallback::before {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            font-style: normal;
            font-weight: bold;
            text-align: center;
        }
        
        /* FontAwesome fallback system - these work when FontAwesome fails to load */
        .fas::before, .far::before {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif !important;
            font-style: normal !important;
            font-weight: normal !important;
            font-variant: normal !important;
            text-transform: none !important;
            line-height: 1 !important;
            display: inline-block !important;
        }
        
        .fas.fa-chart-line::before { content: "üìà" !important; }
        .fas.fa-chart-pie::before { content: "üìä" !important; }
        .fas.fa-list-alt::before { content: "üìã" !important; }
        .fas.fa-heartbeat::before { content: "üíì" !important; }
        .fas.fa-folder-open::before { content: "üìÇ" !important; }
        .fas.fa-play-circle::before { content: "‚ñ∂Ô∏è" !important; }
        .fas.fa-code::before { content: "üíª" !important; }
        .fas.fa-th-large::before { content: "‚äû" !important; }
        .fas.fa-chart-bar::before { content: "üìä" !important; }
        .fas.fa-moon::before { content: "üåô" !important; }
        .fas.fa-sun::before { content: "‚òÄÔ∏è" !important; }
        .fas.fa-spinner::before { content: "‚è≥" !important; }
        .fas.fa-exclamation-triangle::before { content: "‚ö†Ô∏è" !important; }
        .fas.fa-flask::before { content: "üß™" !important; }
        .fas.fa-plus-circle::before { content: "‚ûï" !important; }
        .fas.fa-rocket::before { content: "üöÄ" !important; }
        .fas.fa-code-branch::before { content: "üåø" !important; }
        .fas.fa-home::before { content: "üè†" !important; }
        .fas.fa-chevron-right::before { content: "‚ñ∂" !important; }
        .fas.fa-arrow-left::before { content: "‚Üê" !important; }
        .fas.fa-star::before { content: "‚≠ê" !important; }
        .far.fa-star::before { content: "‚òÜ" !important; }
        .fas.fa-cog::before { content: "‚öôÔ∏è" !important; }
        .fas.fa-adjust::before { content: "üåó" !important; }
        .fas.fa-times::before { content: "‚úï" !important; }
        .fas.fa-palette::before { content: "üé®" !important; }
        .fas.fa-filter::before { content: "üîΩ" !important; }
        .fas.fa-sort::before { content: "‚ÜïÔ∏è" !important; }
        .fas.fa-eye::before { content: "üëÅÔ∏è" !important; }
        .fas.fa-tachometer-alt::before { content: "üìä" !important; }
        
        /* Ensure icons work when FontAwesome loads */
        .fas[class*="fa-"]::before {
            font-size: inherit;
            margin-right: 0;
        }
    </style>
    
    <style>
        :root {
            /* Brand Colors - Modern Palette */
            --primary: #10b981;
            --primary-dark: #047857;
            --primary-light: #34d399;
            --secondary: #3b82f6;
            --accent: #8b5cf6;
            
            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
            --muted: #6b7280;
            
            /* Light Theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #ffffff;
            --bg-surface: #ffffff;
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --text-inverse: #ffffff;
            
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-heavy: #94a3b8;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            
            /* Border Radius */
            --radius-xs: 0.25rem;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 250ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-elevated: #1e293b;
            --bg-surface: #0f172a;
            
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            --text-inverse: #0f172a;
            
            --border-light: #334155;
            --border-medium: #475569;
            --border-heavy: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        }
        
        /* Modern Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 80px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-container {
            width: 64px;
            height: 64px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: transform var(--transition-fast);
        }
        
        .logo-container:hover {
            transform: scale(1.05);
        }
        
        .logo-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(1.1);
        }
        
        .brand-text h1 {
            font-size: 1.875rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
        }
        
        .brand-text p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            display: block;
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            cursor: pointer;
            color: white;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }
        
        .theme-toggle i {
            font-size: 1.125rem;
        }
        
        /* Modern Navigation */
        .navigation {
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-light);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            padding: 0 2rem;
        }
        
        .nav-button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: -1;
        }
        
        .nav-button:hover {
            color: var(--primary);
        }
        
        .nav-button:hover::before {
            opacity: 0.05;
        }
        
        .nav-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Modern Cards */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .card-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            position: relative;
            overflow: hidden;
        }
        
        .card-icon::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, currentColor, transparent);
            opacity: 0.1;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        /* Status Badges */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            gap: 0.5rem;
        }
        
        .status.healthy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status.inactive {
            background: rgba(107, 114, 128, 0.1);
            color: var(--muted);
            border: 1px solid rgba(107, 114, 128, 0.2);
        }
        
        .status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-number {
            font-weight: 700;
            font-size: 1.25rem;
        }
        
        .success { color: var(--success); }
        .error { color: var(--error); }
        .warning { color: var(--warning); }
        .info { color: var(--info); }
        .muted { color: var(--muted); }
        
        /* Modern Treemap */
        .treemap-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-2xl);
            padding: 2.5rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }
        
        .treemap-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }
        
        .treemap-title {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .treemap-title h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }
        
        .treemap-title p {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .treemap-svg {
            width: 100%;
            height: 600px;
            border-radius: var(--radius-xl);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
        }
        
        .treemap-cell {
            stroke: var(--bg-primary);
            stroke-width: 3;
            cursor: pointer;
            transition: all var(--transition-normal);
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
        }
        
        .treemap-cell:hover {
            stroke-width: 4;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2));
            transform: scale(1.02);
        }
        
        .treemap-text-project {
            font-size: 14px;
            font-weight: 700;
            fill: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            font-family: 'Inter', sans-serif;
        }
        
        .treemap-text-stats {
            font-size: 12px;
            font-weight: 600;
            fill: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            pointer-events: none;
            font-family: 'Inter', sans-serif;
        }
        
        .treemap-text-count {
            font-size: 11px;
            font-weight: 500;
            fill: rgba(255,255,255,0.9);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            pointer-events: none;
            font-family: 'Inter', sans-serif;
        }
        
        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }
        
        .breadcrumb-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        
        .breadcrumb-item.active {
            color: var(--primary);
            font-weight: 600;
            cursor: default;
        }
        
        .breadcrumb-item.active:hover {
            background: transparent;
        }
        
        .breadcrumb-separator {
            color: var(--text-tertiary);
            margin: 0 0.25rem;
        }

        /* Modern Tables */
        .table-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--bg-secondary);
            padding: 1.25rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-light);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: top;
        }
        
        tr:hover {
            background: var(--bg-secondary);
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }
        
        .toggle-button {
            background: none;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toggle-button:hover {
            color: var(--primary);
        }
        
        .toggle-button.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        /* Loading States */
        .loading, .error-message {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .loading i, .error-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .loading i {
            color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        .error-message i {
            color: var(--error);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--text-tertiary);
            margin-bottom: 1.5rem;
            display: block;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .empty-state p {
            font-size: 1rem;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-stats {
                gap: 1rem;
                justify-content: center;
            }
            
            .nav-content {
                flex-wrap: wrap;
                padding: 0 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .treemap-svg {
                height: 400px;
            }
            
            .card {
                padding: 1.5rem;
            }
        }
        
        /* Tooltip */
        .treemap-tooltip {
            position: absolute;
            background: var(--bg-primary);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(20px);
            max-width: 300px;
        }
        
        /* Breadcrumb */
        .breadcrumb {
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
        }
        
        .breadcrumb button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            font-size: inherit;
        }
        
        .breadcrumb-separator {
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        /* Legends */
        .treemap-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
        }
        
        /* Card Flip Animation Styles */
        .card-flip-container {
            perspective: 1000px;
            width: 100%;
            min-height: 450px;
            position: relative;
        }
        
        .card-flipper {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        
        .card-flipper.flipped {
            transform: rotateY(180deg);
        }
        
        .card-front,
        .card-back {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: var(--radius-xl);
        }
        
        .card-front {
            z-index: 2;
            transform: rotateY(0deg);
        }
        
        .card-back {
            transform: rotateY(180deg);
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .treemap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 0.5rem;
        }
        
        .treemap-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .project-treemap-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 320px;
            max-height: 340px;
            padding: 0.5rem;
        }
        
        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
        }
        
        .breadcrumb-nav button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: inherit;
            padding: 0;
            text-decoration: underline;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-xs);
        }
        
        .legend-color {
            width: 1rem;
            height: 1rem;
            border-radius: var(--radius-xs);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Test History Chart Styles */
        .test-history-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-2xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 3rem;
        }
        
        .info-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }
        
        .info-note i {
            color: rgb(59, 130, 246);
            margin-top: 0.125rem;
        }
        
        .info-note code {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.125rem 0.375rem;
            border-radius: var(--radius-xs);
            font-family: var(--font-mono);
            font-size: 0.825rem;
        }
        
        .history-header {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .back-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 0.75rem 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .back-button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateX(-2px);
        }
        
        .history-title {
            flex: 1;
        }
        
        .history-title h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }
        
        .history-title p {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }
        
        .suite-filter {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 200px;
        }
        
        .suite-filter label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .suite-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-right: 2.5rem;
        }
        
        .suite-select:hover {
            border-color: var(--primary);
        }
        
        .suite-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Settings Panel Styles */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 420px;
            background: var(--bg-elevated);
            border-left: 1px solid var(--border-light);
            box-shadow: var(--shadow-xl);
            transform: translateX(100%);
            transition: transform var(--transition-normal);
            z-index: 1001;
            overflow-y: auto;
        }

        .settings-panel.open {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-primary);
        }

        .settings-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .settings-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .settings-content {
            padding: 2rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-option {
            margin-bottom: 1rem;
        }

        .settings-option:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .theme-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 0.25rem;
        }

        .theme-option {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .theme-option:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .settings-toggle:hover {
            border-color: var(--primary);
        }

        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }

        .toggle-switch.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition-fast);
            box-shadow: var(--shadow-xs);
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .order-selector {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            appearance: none;
            width: 100%;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .order-selector:hover {
            border-color: var(--primary);
        }

        .order-selector:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .project-checklist {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
        }

        .project-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .project-checkbox:last-child {
            border-bottom: none;
        }

        .project-checkbox:hover {
            background: var(--bg-tertiary);
        }

        .project-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .project-checkbox-label {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
        }

        .settings-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-light);
        }

        .settings-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid var(--border-light);
        }

        .settings-button.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .settings-button.primary:hover {
            background: var(--primary-dark);
        }

        .settings-button.secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .settings-button.secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .favorite-star {
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-tertiary);
            font-size: 1rem;
        }

        .favorite-star:hover {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .favorite-star.favorited {
            color: #fbbf24;
        }

        .favorites-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Destructure React hooks at the top level
        const { useState, useEffect, useRef } = React;

        // User preferences management system
        function useUserPreferences() {
            // Default preferences structure
            const defaultPreferences = {
                theme: 'auto', // 'light', 'dark', 'auto'
                favorites: [], // Array of project IDs
                showFavoritesOnly: false,
                projectOrder: 'default', // 'default', 'alphabetical', 'recent', 'success-rate', 'custom'
                customProjectOrder: [], // Array of project IDs in custom order
                defaultTestSummariesView: 'grid', // 'grid' or 'treemap'
                managerDashboard: {
                    enabled: false,
                    selectedProjects: [], // Array of project IDs to include in uber treemap
                },
                version: 1 // For future migrations
            };

            // Initialize preferences from localStorage or defaults
            const [preferences, setPreferences] = useState(() => {
                try {
                    const saved = localStorage.getItem('fern-platform-preferences');
                    const parsed = saved ? JSON.parse(saved) : {};
                    return { ...defaultPreferences, ...parsed };
                } catch (error) {
                    console.warn('Failed to load preferences, using defaults:', error);
                    return defaultPreferences;
                }
            });
            
            // Track if we've loaded from database
            const [dbLoaded, setDbLoaded] = useState(false);
            
            // Load preferences from database on mount
            useEffect(() => {
                const loadFromDatabase = async () => {
                    try {
                        const data = await window.graphqlClient.query(window.GRAPHQL_QUERIES.GET_USER_PREFERENCES);
                        if (data && data.userPreferences) {
                            const dbPrefs = data.userPreferences;
                            const mergedPrefs = {
                                ...defaultPreferences,
                                theme: dbPrefs.theme || defaultPreferences.theme,
                                favorites: dbPrefs.favorites || [],
                                ...(dbPrefs.preferences || {})
                            };
                            setPreferences(mergedPrefs);
                            setDbLoaded(true);
                        }
                    } catch (error) {
                        console.warn('Failed to load preferences from database:', error);
                        // Continue with localStorage/default preferences
                    }
                };
                
                loadFromDatabase();
            }, []);

            // Computed theme based on preference and system
            const [effectiveTheme, setEffectiveTheme] = useState('light');

            // Update effective theme when preferences change or system preference changes
            useEffect(() => {
                const updateEffectiveTheme = () => {
                    let newTheme = preferences.theme;
                    
                    if (newTheme === 'auto') {
                        // Detect system preference
                        newTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    }
                    
                    setEffectiveTheme(newTheme);
                    document.documentElement.setAttribute('data-theme', newTheme);
                };

                updateEffectiveTheme();

                // Listen for system theme changes when in auto mode
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleSystemThemeChange = () => {
                    if (preferences.theme === 'auto') {
                        updateEffectiveTheme();
                    }
                };

                mediaQuery.addEventListener('change', handleSystemThemeChange);
                return () => mediaQuery.removeEventListener('change', handleSystemThemeChange);
            }, [preferences.theme]);

            // Save preferences to localStorage and database whenever they change
            useEffect(() => {
                // Save to localStorage
                try {
                    localStorage.setItem('fern-platform-preferences', JSON.stringify(preferences));
                } catch (error) {
                    console.error('Failed to save preferences to localStorage:', error);
                }
                
                // Save to database (debounced to avoid too many requests)
                if (dbLoaded) {
                    const saveToDatabase = async () => {
                        try {
                            await window.graphqlClient.mutation(
                                window.GRAPHQL_QUERIES.UPDATE_USER_PREFERENCES,
                                {
                                    input: {
                                        theme: preferences.theme,
                                        favorites: preferences.favorites,
                                        preferences: {
                                            showFavoritesOnly: preferences.showFavoritesOnly,
                                            projectOrder: preferences.projectOrder,
                                            customProjectOrder: preferences.customProjectOrder,
                                            defaultTestSummariesView: preferences.defaultTestSummariesView,
                                            managerDashboard: preferences.managerDashboard,
                                            version: preferences.version
                                        }
                                    }
                                }
                            );
                        } catch (error) {
                            console.error('Failed to save preferences to database:', error);
                        }
                    };
                    
                    // Debounce database saves
                    const timeoutId = setTimeout(saveToDatabase, 1000);
                    return () => clearTimeout(timeoutId);
                }
            }, [preferences, dbLoaded]);

            // Preference update functions
            const updatePreferences = (updates) => {
                setPreferences(prev => ({ ...prev, ...updates }));
            };

            const setTheme = (theme) => {
                updatePreferences({ theme });
            };

            const toggleTheme = () => {
                const themes = ['light', 'dark', 'auto'];
                const currentIndex = themes.indexOf(preferences.theme);
                const nextTheme = themes[(currentIndex + 1) % themes.length];
                setTheme(nextTheme);
            };

            const toggleFavorite = async (projectId) => {
                const newFavorites = preferences.favorites.includes(projectId)
                    ? preferences.favorites.filter(id => id !== projectId)
                    : [...preferences.favorites, projectId];
                
                // Update local state immediately for responsiveness
                updatePreferences({ favorites: newFavorites });
                
                // Persist to database
                try {
                    const data = await window.graphqlClient.mutation(
                        window.GRAPHQL_QUERIES.TOGGLE_PROJECT_FAVORITE,
                        { projectId }
                    );
                    
                    // Update with server response if different
                    if (data && data.toggleProjectFavorite && data.toggleProjectFavorite.favorites) {
                        updatePreferences({ favorites: data.toggleProjectFavorite.favorites });
                    }
                } catch (error) {
                    console.error('Failed to update favorite in database:', error);
                    // The local update remains even if database fails
                }
            };

            const isFavorite = (projectId) => {
                return preferences.favorites.includes(projectId);
            };

            const setShowFavoritesOnly = (show) => {
                updatePreferences({ showFavoritesOnly: show });
            };

            const setProjectOrder = (order) => {
                updatePreferences({ projectOrder: order });
            };

            const setCustomProjectOrder = (projectIds) => {
                updatePreferences({ 
                    customProjectOrder: projectIds,
                    projectOrder: 'custom'
                });
            };

            const setDefaultTestSummariesView = (view) => {
                updatePreferences({ defaultTestSummariesView: view });
            };

            const updateManagerDashboard = (updates) => {
                updatePreferences({ 
                    managerDashboard: { ...preferences.managerDashboard, ...updates }
                });
            };

            const resetPreferences = () => {
                setPreferences(defaultPreferences);
            };

            // Helper function to sort projects based on preferences
            const sortProjects = (projects) => {
                if (!projects || projects.length === 0) return projects;

                const { projectOrder, customProjectOrder } = preferences;

                switch (projectOrder) {
                    case 'alphabetical':
                        return [...projects].sort((a, b) => 
                            (a.name || a.project_id || '').localeCompare(b.name || b.project_id || '')
                        );
                    
                    case 'recent':
                        return [...projects].sort((a, b) => 
                            new Date(b.last_run_time || 0) - new Date(a.last_run_time || 0)
                        );
                    
                    case 'success-rate':
                        return [...projects].sort((a, b) => {
                            const aRate = a.total_tests > 0 ? (a.passed_tests || 0) / a.total_tests : 0;
                            const bRate = b.total_tests > 0 ? (b.passed_tests || 0) / b.total_tests : 0;
                            return bRate - aRate;
                        });
                    
                    case 'custom':
                        const ordered = [];
                        const remaining = [...projects];
                        
                        // Add projects in custom order
                        customProjectOrder.forEach(projectId => {
                            const index = remaining.findIndex(p => 
                                (p.project_id || p.id) === projectId
                            );
                            if (index !== -1) {
                                ordered.push(remaining.splice(index, 1)[0]);
                            }
                        });
                        
                        // Add any remaining projects at the end
                        return [...ordered, ...remaining];
                    
                    default:
                        return projects;
                }
            };

            // Filter projects based on favorites preference
            const filterProjects = (projects) => {
                if (!preferences.showFavoritesOnly || preferences.favorites.length === 0) {
                    return projects;
                }
                
                return projects.filter(project => 
                    preferences.favorites.includes(project.project_id || project.id)
                );
            };

            return {
                preferences,
                effectiveTheme,
                theme: effectiveTheme, // For backward compatibility
                updatePreferences,
                setTheme,
                toggleTheme,
                toggleFavorite,
                isFavorite,
                setShowFavoritesOnly,
                setProjectOrder,
                setCustomProjectOrder,
                setDefaultTestSummariesView,
                updateManagerDashboard,
                resetPreferences,
                sortProjects,
                filterProjects
            };
        }

        // Settings Panel Component
        function SettingsPanel({ isOpen, onClose, projects = [] }) {
            const userPrefs = useUserPreferences();
            const {
                preferences,
                setTheme,
                setShowFavoritesOnly,
                setProjectOrder,
                setDefaultTestSummariesView,
                updateManagerDashboard,
                resetPreferences
            } = userPrefs;

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const handleProjectToggle = (projectId, checked) => {
                const currentSelected = preferences.managerDashboard.selectedProjects;
                const newSelected = checked
                    ? [...currentSelected, projectId]
                    : currentSelected.filter(id => id !== projectId);
                
                updateManagerDashboard({ selectedProjects: newSelected });
            };

            const handleSelectAllProjects = () => {
                const allProjectIds = projects.map(p => p.project_id || p.id);
                updateManagerDashboard({ selectedProjects: allProjectIds });
            };

            const handleDeselectAllProjects = () => {
                updateManagerDashboard({ selectedProjects: [] });
            };

            return (
                <div className={`settings-overlay ${isOpen ? 'open' : ''}`} onClick={handleOverlayClick}>
                    <div className={`settings-panel ${isOpen ? 'open' : ''}`}>
                        <div className="settings-header">
                            <div className="settings-title">
                                <i className="fas fa-cog"></i>
                                User Preferences
                            </div>
                            <button className="settings-close" onClick={onClose}>
                                <i className="fas fa-times"></i>
                            </button>
                        </div>

                        <div className="settings-content">
                            {/* Theme Section */}
                            <div className="settings-section">
                                <div className="settings-section-title">
                                    <i className="fas fa-palette"></i>
                                    Appearance
                                </div>
                                <div className="settings-option">
                                    <label className="settings-label">Theme</label>
                                    <div className="theme-selector">
                                        <button
                                            className={`theme-option ${preferences.theme === 'light' ? 'active' : ''}`}
                                            onClick={() => setTheme('light')}
                                        >
                                            <i className="fas fa-sun"></i>
                                            Light
                                        </button>
                                        <button
                                            className={`theme-option ${preferences.theme === 'dark' ? 'active' : ''}`}
                                            onClick={() => setTheme('dark')}
                                        >
                                            <i className="fas fa-moon"></i>
                                            Dark
                                        </button>
                                        <button
                                            className={`theme-option ${preferences.theme === 'auto' ? 'active' : ''}`}
                                            onClick={() => setTheme('auto')}
                                        >
                                            <i className="fas fa-adjust"></i>
                                            Auto
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Projects Section */}
                            <div className="settings-section">
                                <div className="settings-section-title">
                                    <i className="fas fa-star"></i>
                                    Projects
                                </div>
                                <div className="settings-option">
                                    <div 
                                        className="settings-toggle"
                                        onClick={() => setShowFavoritesOnly(!preferences.showFavoritesOnly)}
                                    >
                                        <span className="toggle-label">Show favorites only</span>
                                        <div className={`toggle-switch ${preferences.showFavoritesOnly ? 'active' : ''}`}></div>
                                    </div>
                                </div>
                                {preferences.favorites.length > 0 && (
                                    <div className="settings-option">
                                        <label className="settings-label">
                                            Favorited Projects ({preferences.favorites.length})
                                        </label>
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-tertiary)', lineHeight: '1.4' }}>
                                            {preferences.favorites.map(id => {
                                                const project = projects.find(p => (p.project_id || p.id) === id);
                                                return project ? (project.name || project.project_id || id) : id;
                                            }).join(', ')}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Project Order Section */}
                            <div className="settings-section">
                                <div className="settings-section-title">
                                    <i className="fas fa-sort"></i>
                                    Project Order
                                </div>
                                <div className="settings-option">
                                    <label className="settings-label">Sort projects by</label>
                                    <select 
                                        className="order-selector"
                                        value={preferences.projectOrder}
                                        onChange={(e) => setProjectOrder(e.target.value)}
                                    >
                                        <option value="default">Default order</option>
                                        <option value="alphabetical">Alphabetical (A-Z)</option>
                                        <option value="recent">Most recent activity</option>
                                        <option value="success-rate">Success rate (highest first)</option>
                                        <option value="custom">Custom order</option>
                                    </select>
                                </div>
                            </div>

                            {/* Default View Section */}
                            <div className="settings-section">
                                <div className="settings-section-title">
                                    <i className="fas fa-eye"></i>
                                    Default Views
                                </div>
                                <div className="settings-option">
                                    <label className="settings-label">Default Test Summaries view</label>
                                    <select 
                                        className="order-selector"
                                        value={preferences.defaultTestSummariesView}
                                        onChange={(e) => setDefaultTestSummariesView(e.target.value)}
                                    >
                                        <option value="grid">Grid View</option>
                                        <option value="treemap">Treemap View</option>
                                    </select>
                                </div>
                            </div>

                            {/* Manager Dashboard Section */}
                            <div className="settings-section">
                                <div className="settings-section-title">
                                    <i className="fas fa-tachometer-alt"></i>
                                    Manager Dashboard
                                </div>
                                <div className="settings-option">
                                    <div 
                                        className="settings-toggle"
                                        onClick={() => updateManagerDashboard({ enabled: !preferences.managerDashboard.enabled })}
                                    >
                                        <span className="toggle-label">Enable uber treemap view</span>
                                        <div className={`toggle-switch ${preferences.managerDashboard.enabled ? 'active' : ''}`}></div>
                                    </div>
                                </div>
                                
                                {preferences.managerDashboard.enabled && (
                                    <div className="settings-option">
                                        <label className="settings-label">
                                            Select projects to include ({preferences.managerDashboard.selectedProjects.length} selected)
                                        </label>
                                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                            <button 
                                                className="settings-button secondary"
                                                onClick={handleSelectAllProjects}
                                                style={{ fontSize: '0.75rem', padding: '0.5rem 0.75rem' }}
                                            >
                                                Select All
                                            </button>
                                            <button 
                                                className="settings-button secondary"
                                                onClick={handleDeselectAllProjects}
                                                style={{ fontSize: '0.75rem', padding: '0.5rem 0.75rem' }}
                                            >
                                                Deselect All
                                            </button>
                                        </div>
                                        <div className="project-checklist">
                                            {projects.map(project => {
                                                const projectId = project.project_id || project.id;
                                                const isSelected = preferences.managerDashboard.selectedProjects.includes(projectId);
                                                
                                                return (
                                                    <div 
                                                        key={projectId}
                                                        className="project-checkbox"
                                                        onClick={() => handleProjectToggle(projectId, !isSelected)}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={isSelected}
                                                            onChange={() => {}} // Handled by parent onClick
                                                        />
                                                        <span className="project-checkbox-label">
                                                            {project.name || project.project_id || projectId}
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Actions */}
                            <div className="settings-actions">
                                <button 
                                    className="settings-button secondary"
                                    onClick={resetPreferences}
                                >
                                    Reset to Defaults
                                </button>
                                <button 
                                    className="settings-button primary"
                                    onClick={onClose}
                                >
                                    Save Preferences
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Utility functions
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const getTestStatusColor = (passed, failed, skipped, total) => {
            if (total === 0) return '#6b7280';
            
            const passRate = passed / total;
            
            if (passRate >= 0.9) return '#10b981';
            if (passRate >= 0.7) return '#34d399';
            if (passRate >= 0.5) return '#f59e0b';
            if (passRate >= 0.3) return '#f97316';
            return '#ef4444';
        };

        // Simple router for SPA navigation
        function useRouter() {
            const [route, setRoute] = useState(window.location.hash.slice(1) || '/');
            
            useEffect(() => {
                const handleHashChange = () => {
                    setRoute(window.location.hash.slice(1) || '/');
                };
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);
            
            const navigate = (path) => {
                window.location.hash = path;
            };
            
            return { route, navigate };
        }

        // Authentication state management
        function useAuth() {
            const [user, setUser] = useState(null);
            const [systemConfig, setSystemConfig] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                checkAuth();
            }, []);
            
            const checkAuth = async () => {
                try {
                    // Fetch both user and system config
                    const query = `
                        query GetAuthData {
                            currentUser {
                                id
                                userId
                                email
                                name
                                firstName
                                lastName
                                role
                                profileUrl
                                groups
                                createdAt
                                lastLoginAt
                            }
                            systemConfig {
                                roleGroups {
                                    adminGroup
                                    managerGroup
                                    userGroup
                                }
                            }
                        }
                    `;
                    
                    const data = await graphqlClient.query({ query });
                    if (data && data.currentUser) {
                        setUser(data.currentUser);
                    }
                    if (data && data.systemConfig) {
                        setSystemConfig(data.systemConfig);
                    }
                } catch (error) {
                    console.log('Not authenticated:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const login = () => {
                window.location.href = '/auth/start';
            };
            
            const logout = async () => {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        setUser(null);
                        
                        // Redirect to provider logout URL to destroy provider session
                        // This will redirect back to our login page via post_logout_redirect_uri
                        window.location.href = data.logout_url;
                    } else {
                        throw new Error('Logout request failed');
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                    // Even if logout fails, clear user state and redirect
                    setUser(null);
                    window.location.href = '/auth/login';
                }
            };
            
            // Check if user is a manager (has the manager role group)
            const roleGroups = systemConfig?.roleGroups || {
                adminGroup: 'admin',
                managerGroup: 'manager',
                userGroup: 'user'
            };
            
            const isManager = user?.groups?.some(group => 
                group === roleGroups.managerGroup || group === roleGroups.adminGroup
            ) || user?.role === 'admin';
            
            const isAdmin = user?.groups?.some(group => 
                group === roleGroups.adminGroup
            ) || user?.role === 'admin';
            
            // Get user's teams (excluding role groups)
            const userTeams = user?.groups?.filter(group => {
                // Exclude role groups
                return group !== roleGroups.adminGroup && 
                       group !== roleGroups.managerGroup && 
                       group !== roleGroups.userGroup;
            }) || [];
            
            return { 
                user, 
                systemConfig,
                loading, 
                login, 
                logout, 
                isAdmin,
                isManager,
                userTeams
            };
        }

        // User menu component
        function UserMenu({ user, onLogout, onOpenSettings }) {
            const [isOpen, setIsOpen] = useState(false);
            
            const toggleMenu = () => setIsOpen(!isOpen);
            
            const handleLogout = () => {
                setIsOpen(false);
                onLogout();
            };
            
            const handleSettings = () => {
                setIsOpen(false);
                onOpenSettings();
            };
            
            return (
                <div className="user-menu" style={{position: 'relative'}}>
                    <button 
                        className="user-menu-trigger"
                        onClick={toggleMenu}
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            background: 'rgba(255, 255, 255, 0.1)',
                            border: '1px solid rgba(255, 255, 255, 0.2)',
                            borderRadius: '8px',
                            padding: '0.5rem 0.75rem',
                            color: 'white',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.background = 'rgba(255, 255, 255, 0.15)';
                            e.target.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                            e.target.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        }}
                    >
                        <div className="user-avatar" style={{
                            width: '24px',
                            height: '24px',
                            borderRadius: '50%',
                            background: user.profile_url ? `url(${user.profile_url})` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            backgroundSize: 'cover',
                            backgroundPosition: 'center',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '12px',
                            fontWeight: '600',
                            color: 'white'
                        }}>
                            {!user.profile_url && (user.name ? user.name.charAt(0).toUpperCase() : 'üë§')}
                        </div>
                        <span style={{fontSize: '14px', fontWeight: '500'}}>
                            {user.name || user.email}
                        </span>
                        {user.role === 'admin' && (
                            <span style={{
                                fontSize: '10px',
                                padding: '2px 6px',
                                background: 'rgba(16, 185, 129, 0.2)',
                                color: '#10b981',
                                borderRadius: '4px',
                                fontWeight: '600'
                            }}>
                                ADMIN
                            </span>
                        )}
                        <i className="fas fa-chevron-down" style={{
                            fontSize: '12px',
                            transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)',
                            transition: 'transform 0.2s ease'
                        }}></i>
                    </button>
                    
                    {isOpen && (
                        <div className="user-menu-dropdown" style={{
                            position: 'absolute',
                            top: '100%',
                            right: '0',
                            marginTop: '0.5rem',
                            background: 'var(--bg-elevated)',
                            border: '1px solid var(--border-color)',
                            borderRadius: '8px',
                            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.1)',
                            minWidth: '200px',
                            zIndex: 1000,
                            overflow: 'hidden'
                        }}>
                            <div style={{
                                padding: '1rem',
                                borderBottom: '1px solid var(--border-color)',
                                background: 'var(--bg-secondary)'
                            }}>
                                <div style={{fontWeight: '600', color: 'var(--text-primary)', marginBottom: '0.25rem'}}>
                                    {user.name}
                                </div>
                                <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)'}}>
                                    {user.email}
                                </div>
                                <div style={{fontSize: '0.75rem', color: 'var(--text-tertiary)', marginTop: '0.25rem'}}>
                                    Role: {user.role}
                                </div>
                            </div>
                            
                            <div style={{padding: '0.5rem'}}>
                                <button
                                    onClick={handleSettings}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        background: 'transparent',
                                        border: 'none',
                                        borderRadius: '6px',
                                        textAlign: 'left',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.75rem',
                                        color: 'var(--text-primary)',
                                        transition: 'background-color 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => e.target.style.background = 'var(--bg-secondary)'}
                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                >
                                    <i className="fas fa-cog"></i>
                                    <span>Settings & Preferences</span>
                                </button>
                                
                                {user.role === 'admin' && (
                                    <button
                                        onClick={() => window.location.href = '/admin'}
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem',
                                            background: 'transparent',
                                            border: 'none',
                                            borderRadius: '6px',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.75rem',
                                            color: 'var(--text-primary)',
                                            transition: 'background-color 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => e.target.style.background = 'var(--bg-secondary)'}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        <i className="fas fa-shield-alt"></i>
                                        <span>Admin Panel</span>
                                    </button>
                                )}
                                
                                <div style={{
                                    height: '1px',
                                    background: 'var(--border-color)',
                                    margin: '0.5rem 0'
                                }}></div>
                                
                                <button
                                    onClick={handleLogout}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        background: 'transparent',
                                        border: 'none',
                                        borderRadius: '6px',
                                        textAlign: 'left',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.75rem',
                                        color: 'var(--error)',
                                        transition: 'background-color 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => e.target.style.background = 'rgba(239, 68, 68, 0.1)'}
                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                >
                                    <i className="fas fa-sign-out-alt"></i>
                                    <span>Sign Out</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Login button component
        function LoginButton({ onLogin }) {
            return (
                <button
                    onClick={onLogin}
                    style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        background: 'rgba(255, 255, 255, 0.1)',
                        border: '1px solid rgba(255, 255, 255, 0.2)',
                        borderRadius: '8px',
                        padding: '0.5rem 1rem',
                        color: 'white',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}
                    onMouseEnter={(e) => {
                        e.target.style.background = 'rgba(255, 255, 255, 0.15)';
                        e.target.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                        e.target.style.transform = 'translateY(-1px)';
                    }}
                    onMouseLeave={(e) => {
                        e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                        e.target.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        e.target.style.transform = 'translateY(0px)';
                    }}
                >
                    <i className="fas fa-sign-in-alt">üîë</i>
                    <span>Sign In</span>
                </button>
            );
        }

        // Modern Header component
        function Header({ health, projects, testRuns, onOpenSettings }) {
            const { theme, toggleTheme } = useUserPreferences();
            const { user, loading, login, logout } = useAuth();
            const activeProjects = projects.filter(p => p.isActive).length;
            const recentRuns = testRuns.filter(tr => {
                const runDate = new Date(tr.startTime);
                const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                return runDate > dayAgo;
            }).length;

            const getThemeIcon = () => {
                switch (theme) {
                    case 'light': return 'fas fa-sun';
                    case 'dark': return 'fas fa-moon';
                    case 'auto': return 'fas fa-adjust';
                    default: return 'fas fa-adjust';
                }
            };

            const getThemeTooltip = () => {
                switch (theme) {
                    case 'light': return 'Switch to dark theme';
                    case 'dark': return 'Switch to auto theme';
                    case 'auto': return 'Switch to light theme';
                    default: return 'Toggle theme';
                }
            };

            return (
                <div className="header">
                    <div className="header-content">
                        <div className="logo-section">
                            <div className="logo-container">
                                <img 
                                    src="/web/images/logo-no-background.png" 
                                    alt="Fern Platform" 
                                    className="logo-image"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.nextSibling.style.display = 'flex';
                                    }}
                                />
                                <div style={{display: 'none', alignItems: 'center', justifyContent: 'center', width: '100%', height: '100%', fontSize: '2rem', color: 'white'}}>
                                    üåø
                                </div>
                            </div>
                            <div className="brand-text">
                                <h1>Fern Platform</h1>
                                <p>Modern Test Intelligence</p>
                            </div>
                        </div>
                        
                        <div className="header-controls">
                            <div className="header-stats">
                                <div className="stat-item">
                                    <span className="stat-value">{activeProjects}</span>
                                    <span className="stat-label">Active Projects</span>
                                </div>
                                <div className="stat-item">
                                    <span className="stat-value">{testRuns.length}</span>
                                    <span className="stat-label">Total Runs</span>
                                </div>
                                <div className="stat-item">
                                    <span className="stat-value">{recentRuns}</span>
                                    <span className="stat-label">Recent Runs</span>
                                </div>
                            </div>
                            
                            <button className="theme-toggle" onClick={toggleTheme} title={getThemeTooltip()}>
                                <i className={getThemeIcon()}></i>
                            </button>

                            {/* Authentication UI */}
                            {loading ? (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    padding: '0.5rem 1rem',
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    fontSize: '14px'
                                }}>
                                    <i className="fas fa-spinner fa-spin"></i>
                                    <span>Loading...</span>
                                </div>
                            ) : user ? (
                                <UserMenu 
                                    user={user} 
                                    onLogout={logout} 
                                    onOpenSettings={onOpenSettings}
                                />
                            ) : (
                                <LoginButton onLogin={login} />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Modern Navigation component
        function Navigation({ route, navigate }) {
            const { user, isAdmin, isManager } = useAuth();
            
            const navItems = [
                { path: '/', label: 'Dashboard', icon: 'fas fa-chart-line', fallback: 'üìä' },
                { path: '/test-summaries', label: 'Test Summaries', icon: 'fas fa-chart-pie', fallback: 'üìà' },
                { path: '/test-runs', label: 'Test Runs', icon: 'fas fa-list-alt', fallback: 'üìã' }
            ];
            
            // Add Manager Dashboard for managers AND admins
            const managerItems = (isManager || isAdmin) ? [
                { path: '/manager-dashboard', label: 'Manager Dashboard', icon: 'fas fa-tachometer-alt', fallback: 'üéõÔ∏è', managerOnly: true }
            ] : [];

            // Add project navigation for all authenticated users
            const projectItems = user ? [
                { path: '/projects', label: 'Projects', icon: 'fas fa-folder-open', fallback: 'üìÅ' }
            ] : [];

            // Add admin navigation items if user is admin
            const adminItems = [
                { path: '/admin/users', label: 'User Management', icon: 'fas fa-users', fallback: 'üë•', adminOnly: true },
                { path: '/admin/projects', label: 'All Projects', icon: 'fas fa-folder-open', fallback: 'üìÅ', adminOnly: true },
                { path: '/admin/system', label: 'System Settings', icon: 'fas fa-cogs', fallback: '‚öôÔ∏è', adminOnly: true }
            ];

            const allItems = [...navItems, ...managerItems, ...projectItems, ...(isAdmin ? adminItems : [])];

            return (
                <div className="navigation">
                    <div className="nav-content">
                        {allItems.map(item => (
                            <button 
                                key={item.path}
                                onClick={() => navigate(item.path)}
                                className={`nav-button ${route === item.path ? 'active' : ''} ${item.adminOnly ? 'admin-nav-item' : ''} ${item.managerOnly ? 'manager-nav-item' : ''}`}
                                style={(item.adminOnly || item.managerOnly) ? {
                                    borderLeft: '3px solid var(--primary)',
                                    background: 'linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%)'
                                } : {}}
                            >
                                <i className={item.icon} style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    minWidth: '16px'
                                }}></i>
                                {item.label}
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // Test History Stack Chart Component
        function TestHistoryChart({ project, testRuns, onBack }) {
            const svgRef = useRef();
            const [selectedSuite, setSelectedSuite] = useState('all');
            
            useEffect(() => {
                if (!project || !testRuns.length) return;
                
                // Filter and prepare data for this project
                const projectRuns = testRuns
                    .filter(run => run.projectId === project.projectId)
                    .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
                    .slice(-20); // Show last 20 runs
                
                if (projectRuns.length === 0) return;
                
                const svg = d3.select(svgRef.current);
                svg.selectAll("*").remove();
                
                const container = svg.node().parentNode;
                const margin = { top: 20, right: 60, bottom: 60, left: 60 };
                const width = container.clientWidth - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;
                
                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                // Generate suite data for filtering
                const availableSuites = ['API Tests', 'Integration Tests', 'UI Tests'];
                
                // Prepare stacked data with suite filtering
                const data = projectRuns.map((run, index) => {
                    let suiteData = {};
                    
                    if (selectedSuite === 'all') {
                        // Show total project data
                        const totalTests = run.totalTests || 0;
                        const passedTests = run.passedTests || 0;
                        const failedTests = run.failedTests || 0;
                        let skippedTests = run.skippedTests || 0;
                        
                        // Ensure the sum equals total tests
                        const sum = passedTests + failedTests + skippedTests;
                        if (sum !== totalTests && totalTests > 0) {
                            console.warn(`Test count mismatch for run ${run.id}: passed=${passedTests}, failed=${failedTests}, skipped=${skippedTests}, total=${totalTests}, sum=${sum}`);
                            // Recalculate skipped to ensure consistency
                            skippedTests = Math.max(0, totalTests - passedTests - failedTests);
                            console.log(`Adjusted skipped tests to ${skippedTests} to match total`);
                        }
                        
                        suiteData = {
                            passed: passedTests,
                            failed: failedTests,
                            skipped: skippedTests,
                            total: totalTests
                        };
                    } else {
                        // Generate realistic suite-specific data
                        const totalTests = run.totalTests || 0;
                        const suiteWeights = {
                            'API Tests': 0.6,
                            'Integration Tests': 0.3,
                            'UI Tests': 0.1
                        };
                        const suiteFailureRates = {
                            'API Tests': 0.3,
                            'Integration Tests': 0.15,
                            'UI Tests': 0.1
                        };
                        
                        const suiteTotal = Math.max(1, Math.floor(totalTests * suiteWeights[selectedSuite]));
                        const suiteFailed = Math.floor(suiteTotal * suiteFailureRates[selectedSuite]);
                        const suitePassed = suiteTotal - suiteFailed;
                        
                        suiteData = {
                            passed: suitePassed,
                            failed: suiteFailed,
                            skipped: 0,
                            total: suiteTotal
                        };
                    }
                    
                    return {
                        index: index,
                        date: new Date(run.startTime),
                        passed: suiteData.passed,
                        failed: suiteData.failed,
                        skipped: suiteData.skipped,
                        total: suiteData.total,
                        runId: run.id
                    };
                });
                
                // Debug logging
                console.log('Raw test runs for project:', projectRuns);
                console.log('Test History Data:', data);
                console.log('Data details:', data.map(d => ({
                    index: d.index,
                    passed: d.passed,
                    failed: d.failed,
                    skipped: d.skipped,
                    total: d.total,
                    sum: d.passed + d.failed + d.skipped
                })));
                
                // Find the maximum total to ensure consistent scaling
                const maxTotal = d3.max(data, d => d.total) || 0;
                console.log('Max total tests across all runs:', maxTotal);
                
                // Normalize data to ensure consistent totals if needed
                const normalizedData = data.map(d => {
                    const currentSum = d.passed + d.failed + d.skipped;
                    if (currentSum !== d.total && d.total > 0) {
                        // Adjust skipped to make the sum correct
                        return {
                            ...d,
                            skipped: Math.max(0, d.total - d.passed - d.failed)
                        };
                    }
                    return d;
                });
                
                const keys = ['passed', 'failed', 'skipped'];
                const stack = d3.stack()
                    .keys(keys)
                    .order(d3.stackOrderNone)
                    .offset(d3.stackOffsetNone);
                const stackedData = stack(normalizedData); // Use normalized data
                
                console.log('Normalized Data:', normalizedData);
                console.log('Stacked Data:', stackedData);
                
                // Scales
                const xScale = d3.scaleTime()
                    .domain(d3.extent(normalizedData, d => d.date))
                    .range([0, width]);
                
                // Ensure consistent y-scale based on maximum total tests across all runs
                const yScale = d3.scaleLinear()
                    .domain([0, maxTotal])
                    .range([height, 0])
                    .nice();
                
                const colorScale = d3.scaleOrdinal()
                    .domain(keys)
                    .range(['#10b981', '#ef4444', '#6b7280']);
                
                // Create tooltip
                const tooltip = d3.select("body").selectAll(".stack-tooltip").data([1]);
                const tooltipEnter = tooltip.enter().append("div").attr("class", "stack-tooltip");
                const tooltipMerged = tooltipEnter.merge(tooltip).style("opacity", 0);
                
                // Add CSS for tooltip
                tooltipMerged.style("position", "absolute")
                    .style("background", "rgba(0,0,0,0.9)")
                    .style("color", "white")
                    .style("padding", "12px 16px")
                    .style("border-radius", "8px")
                    .style("font-size", "14px")
                    .style("font-weight", "500")
                    .style("pointer-events", "none")
                    .style("z-index", "1000")
                    .style("box-shadow", "0 4px 12px rgba(0,0,0,0.3)")
                    .style("border", "1px solid rgba(255,255,255,0.1)");
                
                // Area generator
                const area = d3.area()
                    .x(d => xScale(d.data.date))
                    .y0(d => yScale(d[0]))
                    .y1(d => yScale(d[1]))
                    .curve(d3.curveMonotoneX);
                
                // Add areas
                g.selectAll(".stack-area")
                    .data(stackedData)
                    .enter().append("path")
                    .attr("class", "stack-area")
                    .attr("d", area)
                    .attr("fill", d => colorScale(d.key))
                    .attr("opacity", 0.8)
                    .style("transition", "all 0.3s ease")
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr("opacity", 1);
                    })
                    .on("mouseout", function() {
                        d3.select(this).attr("opacity", 0.8);
                    });
                
                // Add data points using stacked data
                stackedData.forEach((layer, layerIndex) => {
                    const key = keys[layerIndex];
                    g.selectAll(`.point-${key}`)
                        .data(layer)
                        .enter().append("circle")
                        .attr("class", `point-${key}`)
                        .attr("cx", d => xScale(d.data.date))
                        .attr("cy", d => yScale(d[1])) // Use the top of the stack layer
                        .attr("r", 4)
                        .attr("fill", colorScale(key))
                        .attr("stroke", "white")
                        .attr("stroke-width", 2)
                        .style("cursor", "pointer")
                        .on("mouseover", function(event, d) {
                            d3.select(this).attr("r", 6);
                            tooltipMerged.transition().duration(200).style("opacity", .95);
                            
                            const passRate = d.data.total > 0 ? ((d.data.passed / d.data.total) * 100).toFixed(1) : 0;
                            const tooltipContent = `
                                <div style="font-weight: 700; margin-bottom: 8px;">Run #${d.data.index + 1}</div>
                                <div style="margin-bottom: 4px;">Date: ${d.data.date.toLocaleDateString()}</div>
                                <div style="margin-bottom: 4px;">‚úÖ Passed: ${d.data.passed}</div>
                                <div style="margin-bottom: 4px;">‚ùå Failed: ${d.data.failed}</div>
                                <div style="margin-bottom: 4px;">‚è≠Ô∏è Skipped: ${d.data.skipped}</div>
                                <div style="margin-bottom: 4px;">üìä Total: ${d.data.total}</div>
                                <div style="margin-top: 8px; font-weight: 600; color: ${d.data.passed === d.data.total ? '#10b981' : d.data.failed > 0 ? '#ef4444' : '#f59e0b'};">Pass Rate: ${passRate}%</div>
                            `;
                            
                            tooltipMerged.html(tooltipContent)
                                .style("left", (event.pageX + 15) + "px")
                                .style("top", (event.pageY - 15) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("r", 4);
                            tooltipMerged.transition().duration(300).style("opacity", 0);
                        });
                });
                
                // Add axes
                const xAxis = d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat("%m/%d %H:%M"))
                    .ticks(Math.min(normalizedData.length, 8));
                
                const yAxis = d3.axisLeft(yScale)
                    .ticks(8);
                
                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis)
                    .selectAll("text")
                    .style("font-size", "11px")
                    .style("fill", "var(--text-secondary)")
                    .attr("transform", "rotate(-45)")
                    .style("text-anchor", "end");
                
                g.append("g")
                    .call(yAxis)
                    .selectAll("text")
                    .style("font-size", "12px")
                    .style("fill", "var(--text-secondary)");
                
                // Add horizontal grid lines
                g.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(yScale)
                        .tickSize(-width)
                        .tickFormat("")
                    )
                    .style("stroke-dasharray", "3,3")
                    .style("opacity", 0.3);
                
                // If all runs have the same total, add a reference line
                const uniqueTotals = [...new Set(normalizedData.map(d => d.total))];
                if (uniqueTotals.length === 1 && uniqueTotals[0] > 0) {
                    const totalTests = uniqueTotals[0];
                    g.append("line")
                        .attr("x1", 0)
                        .attr("x2", width)
                        .attr("y1", yScale(totalTests))
                        .attr("y2", yScale(totalTests))
                        .attr("stroke", "var(--primary)")
                        .attr("stroke-width", 2)
                        .attr("stroke-dasharray", "5,5")
                        .attr("opacity", 0.7);
                    
                    g.append("text")
                        .attr("x", width - 5)
                        .attr("y", yScale(totalTests) - 5)
                        .attr("text-anchor", "end")
                        .style("font-size", "12px")
                        .style("fill", "var(--primary)")
                        .text(`Total: ${totalTests} tests`);
                }
                
                // Add axis labels
                g.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .style("font-size", "14px")
                    .style("fill", "var(--text-secondary)")
                    .text("Number of Tests");
                
                g.append("text")
                    .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 5})`)
                    .style("text-anchor", "middle")
                    .style("font-size", "14px")
                    .style("fill", "var(--text-secondary)")
                    .text("Test Run Date & Time");
                
            }, [project, testRuns, selectedSuite]);
            
            if (!project) return null;
            
            return (
                <div className="test-history-container fade-in">
                    <div className="history-header">
                        <button className="back-button" onClick={onBack}>
                            <i className="fas fa-arrow-left"></i>
                            Back to Overview
                        </button>
                        <div className="history-title">
                            <h3>Test History: {project.name}</h3>
                            <p>Stacked area chart showing pass/fail/skip trends over the last 20 test runs</p>
                        </div>
                        
                        <div className="suite-filter">
                            <label htmlFor="suite-select">Filter by Test Suite:</label>
                            <select 
                                id="suite-select"
                                value={selectedSuite} 
                                onChange={(e) => setSelectedSuite(e.target.value)}
                                className="suite-select"
                            >
                                <option value="all">All Test Suites</option>
                                <option value="API Tests">API Tests</option>
                                <option value="Integration Tests">Integration Tests</option>
                                <option value="UI Tests">UI Tests</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="info-note">
                        <i className="fas fa-info-circle"></i>
                        <div>
                            <strong>Note:</strong> Test counts may vary between runs if your test framework stops executing remaining test suites after encountering failures. 
                            Many testing frameworks have options to continue running all tests even when failures occur (e.g., <code>--keep-going</code>, <code>--bail=false</code>, <code>--no-fail-fast</code>). 
                            Check your test framework's documentation for the appropriate flag to ensure complete test reporting.
                        </div>
                    </div>
                    
                    <div className="chart-container">
                        <svg ref={svgRef} width="100%" height="400"></svg>
                    </div>
                    
                    <div className="chart-legend">
                        <div className="legend-item">
                            <div className="legend-color" style={{background: '#10b981'}}></div>
                            <span>Passed Tests</span>
                        </div>
                        <div className="legend-item">
                            <div className="legend-color" style={{background: '#ef4444'}}></div>
                            <span>Failed Tests</span>
                        </div>
                        <div className="legend-item">
                            <div className="legend-color" style={{background: '#6b7280'}}></div>
                            <span>Skipped Tests</span>
                        </div>
                    </div>
                </div>
            );
        }

        // Uber Treemap Component - Uses aggregated treemap data from GraphQL
        function UberTreemap({ treemapData }) {
            const svgRef = useRef();
            const [tooltip, setTooltip] = useState({ show: false, x: 0, y: 0, content: null });

            useEffect(() => {
                console.log('UberTreemap received data:', treemapData);
                if (!treemapData || !treemapData.projects || treemapData.projects.length === 0) {
                    console.log('UberTreemap: No data to render');
                    return;
                }

                const container = svgRef.current.parentNode;
                const width = container.clientWidth;
                const height = 600;

                // Clear previous content
                d3.select(svgRef.current).selectAll("*").remove();

                const svg = d3.select(svgRef.current)
                    .attr("viewBox", [0, 0, width, height])
                    .attr("width", width)
                    .attr("height", height);

                // Prepare hierarchical data - projects at top level
                const hierarchicalData = {
                    name: "All Projects",
                    children: treemapData.projects.map(projectNode => ({
                        name: projectNode.project.name,
                        value: projectNode.totalDuration || 1,
                        data: {
                            ...projectNode,
                            type: 'project'
                        },
                        children: projectNode.suites.map(suiteNode => ({
                            name: suiteNode.suite.suiteName,
                            value: suiteNode.totalDuration || 1,
                            data: {
                                ...suiteNode,
                                type: 'suite',
                                projectName: projectNode.project.name
                            }
                        }))
                    }))
                };

                const root = d3.hierarchy(hierarchicalData)
                    .sum(d => d.value)
                    .sort((a, b) => b.value - a.value);

                d3.treemap()
                    .size([width, height])
                    .paddingOuter(3)
                    .paddingTop(20)
                    .paddingInner(2)
                    .round(true)(root);

                // Color scale
                const colorScale = d3.scaleSequential(d3.interpolateRdYlGn)
                    .domain([0, 1]);

                // Show only the first level (projects) initially
                const nodes = root.children || []; // Get project nodes
                
                // Create groups for each project
                const cell = svg.selectAll("g")
                    .data(nodes)
                    .join("g")
                    .attr("transform", d => `translate(${d.x0},${d.y0})`);

                // Add rectangles
                cell.append("rect")
                    .attr("width", d => d.x1 - d.x0)
                    .attr("height", d => d.y1 - d.y0)
                    .attr("fill", d => {
                        const passRate = d.data.data.passRate || 0;
                        return colorScale(passRate);
                    })
                    .attr("stroke", "var(--bg-primary)")
                    .attr("stroke-width", 2)
                    .style("cursor", "pointer")
                    .on("mouseover", function(event, d) {
                        const rect = this.getBoundingClientRect();
                        setTooltip({
                            show: true,
                            x: rect.left + rect.width / 2,
                            y: rect.top - 10,
                            content: d.data.data
                        });
                    })
                    .on("mouseout", () => {
                        setTooltip({ show: false, x: 0, y: 0, content: null });
                    });

                // Add project name at the top
                cell.append("text")
                    .attr("x", d => (d.x1 - d.x0) / 2)
                    .attr("y", 25)
                    .attr("text-anchor", "middle")
                    .style("font-size", d => {
                        const width = d.x1 - d.x0;
                        if (width < 100) return "12px";
                        if (width < 200) return "14px";
                        return "16px";
                    })
                    .style("fill", d => {
                        const passRate = d.data.data.passRate || 0;
                        return passRate > 0.5 ? "rgba(0, 0, 0, 0.8)" : "rgba(255, 255, 255, 0.9)";
                    })
                    .style("font-weight", "600")
                    .text(d => {
                        const width = d.x1 - d.x0;
                        const name = d.data.name;
                        if (width < 80) return name.substring(0, 8) + "...";
                        if (width < 150) return name.substring(0, 15) + "...";
                        return name;
                    });

                // Add pass rate percentage in the center
                cell.append("text")
                    .attr("x", d => (d.x1 - d.x0) / 2)
                    .attr("y", d => (d.y1 - d.y0) / 2)
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "middle")
                    .style("font-size", d => {
                        const width = d.x1 - d.x0;
                        const height = d.y1 - d.y0;
                        const minDim = Math.min(width, height);
                        if (minDim < 80) return "16px";
                        if (minDim < 120) return "24px";
                        if (minDim < 200) return "32px";
                        return "40px";
                    })
                    .style("fill", d => {
                        const passRate = d.data.data.passRate || 0;
                        return passRate > 0.5 ? "rgba(0, 0, 0, 0.9)" : "rgba(255, 255, 255, 1)";
                    })
                    .style("font-weight", "700")
                    .text(d => {
                        const passRate = d.data.data.passRate || 0;
                        return `${(passRate * 100).toFixed(0)}%`;
                    });

                // Add test count at the bottom
                cell.append("text")
                    .attr("x", d => (d.x1 - d.x0) / 2)
                    .attr("y", d => d.y1 - d.y0 - 10)
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("fill", d => {
                        const passRate = d.data.data.passRate || 0;
                        return passRate > 0.5 ? "rgba(0, 0, 0, 0.6)" : "rgba(255, 255, 255, 0.7)";
                    })
                    .text(d => {
                        const width = d.x1 - d.x0;
                        if (width < 80) return "";
                        return `${d.data.data.totalTests} tests`;
                    });

            }, [treemapData]);

            return (
                <div style={{ position: 'relative' }}>
                    <svg ref={svgRef} style={{ width: '100%', height: '600px' }}></svg>
                    
                    {tooltip.show && tooltip.content && (
                        <div className="treemap-tooltip" style={{
                            position: 'fixed',
                            left: tooltip.x,
                            top: tooltip.y,
                            transform: 'translate(-50%, -100%)',
                            zIndex: 1000
                        }}>
                            <div style={{ fontWeight: '600', marginBottom: '0.5rem' }}>
                                {tooltip.content.type === 'suite' && tooltip.content.projectName && 
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>
                                        {tooltip.content.projectName}
                                    </div>
                                }
                                {tooltip.content.type === 'project' ? tooltip.content.project.name : tooltip.content.suite.suiteName}
                            </div>
                            <div style={{ display: 'grid', gap: '0.25rem', fontSize: '0.875rem' }}>
                                <div>
                                    <span style={{ color: 'var(--text-secondary)' }}>Pass Rate:</span>{' '}
                                    <span style={{ fontWeight: '500', color: tooltip.content.passRate > 0.8 ? 'var(--success)' : tooltip.content.passRate > 0.5 ? 'var(--warning)' : 'var(--error)' }}>
                                        {(tooltip.content.passRate * 100).toFixed(1)}%
                                    </span>
                                </div>
                                <div>
                                    <span style={{ color: 'var(--text-secondary)' }}>Total:</span>{' '}
                                    <span style={{ fontWeight: '500' }}>
                                        {tooltip.content.type === 'suite' ? `${tooltip.content.totalSpecs} specs` : `${tooltip.content.totalTests} tests`}
                                    </span>
                                </div>
                                <div>
                                    <span style={{ color: 'var(--text-secondary)' }}>Duration:</span>{' '}
                                    <span style={{ fontWeight: '500' }}>
                                        {(tooltip.content.totalDuration / 1000).toFixed(1)}s
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Enhanced Treemap Visualization
        function TreemapVisualization({ projects, testRuns }) {
            const svgRef = useRef();
            const [currentView, setCurrentView] = useState({ type: 'projects', data: null });
            const [breadcrumb, setBreadcrumb] = useState([]);
            const [showHistory, setShowHistory] = useState(false);
            const [selectedProject, setSelectedProject] = useState(null);

            const navigateToView = (viewType, data = null, breadcrumbPath = []) => {
                setCurrentView({ type: viewType, data });
                setBreadcrumb(breadcrumbPath);
            };
            
            const showProjectHistory = (project) => {
                setSelectedProject(project);
                setShowHistory(true);
            };
            
            const hideProjectHistory = () => {
                setShowHistory(false);
                setSelectedProject(null);
            };
            
            if (showHistory && selectedProject) {
                return <TestHistoryChart 
                    project={selectedProject} 
                    testRuns={testRuns} 
                    onBack={hideProjectHistory} 
                />;
            }

            const getStatusColor = (status) => {
                switch (status) {
                    case 'passed': return '#10b981';
                    case 'failed': return '#ef4444';
                    case 'skipped': return '#6b7280';
                    default: return '#e5e7eb';
                }
            };

            const generateTestSuites = (testRun) => {
                if (!testRun) return [];

                const suiteTemplates = [
                    { 
                        name: 'API Tests', 
                        description: 'REST endpoints and GraphQL API tests',
                        weight: 0.6,
                        failureRate: 0.3
                    },
                    { 
                        name: 'Integration Tests', 
                        description: 'End-to-end workflow testing',
                        weight: 0.3,
                        failureRate: 0.15
                    },
                    { 
                        name: 'UI Tests', 
                        description: 'Dashboard and web interface tests',
                        weight: 0.1,
                        failureRate: 0.1
                    }
                ];

                const totalTests = testRun.totalTests || 0;
                if (totalTests === 0) return [];

                return suiteTemplates.map(template => {
                    const suiteTests = Math.max(1, Math.floor(totalTests * template.weight));
                    const suiteFailed = Math.floor(suiteTests * template.failureRate);
                    const suitePassed = suiteTests - suiteFailed;
                    
                    return {
                        name: template.name,
                        description: template.description,
                        total: suiteTests,
                        passed: suitePassed,
                        failed: suiteFailed,
                        skipped: 0,
                        duration: Math.random() * 5000 + 1000,
                        type: 'suite'
                    };
                });
            };

            // Generate individual tests for a suite
            const generateIndividualTests = (suite) => {
                const testNames = [
                    'should authenticate user',
                    'should validate input data',
                    'should handle error cases',
                    'should process requests',
                    'should return correct results',
                    'should check permissions',
                    'should save data correctly',
                    'should load configuration',
                    'should verify responses',
                    'should timeout properly',
                    'should handle exceptions',
                    'should validate schemas',
                    'should process workflows',
                    'should manage sessions',
                    'should cache responses'
                ];

                const tests = [];
                let remainingPassed = suite.passed;
                let remainingFailed = suite.failed;
                let remainingSkipped = suite.skipped;

                for (let i = 0; i < suite.total; i++) {
                    let status;
                    if (remainingPassed > 0) {
                        status = 'passed';
                        remainingPassed--;
                    } else if (remainingFailed > 0) {
                        status = 'failed';
                        remainingFailed--;
                    } else {
                        status = 'skipped';
                        remainingSkipped--;
                    }

                    tests.push({
                        name: testNames[i % testNames.length] + ` ${i + 1}`,
                        status: status,
                        duration: Math.random() * 3000 + 100, // 100ms-3s
                        message: status === 'failed' ? 'Test assertion failed' : '',
                        type: 'test'
                    });
                }

                return tests.sort((a, b) => b.duration - a.duration); // Sort by duration descending
            };

            useEffect(() => {
                if (!projects.length) return;
                
                console.log('TreemapVisualization - projects:', projects);
                console.log('TreemapVisualization - testRuns:', testRuns);
                console.log('TreemapVisualization - currentView:', currentView);

                const svg = d3.select(svgRef.current);
                svg.selectAll("*").remove();

                const container = svg.node().parentNode;
                const width = container.clientWidth;
                const height = 600;

                // Create tooltip
                const tooltip = d3.select("body").selectAll(".treemap-tooltip").data([1]);
                const tooltipEnter = tooltip.enter().append("div").attr("class", "treemap-tooltip");
                const tooltipMerged = tooltipEnter.merge(tooltip).style("opacity", 0);

                let treemapData = [];

                if (currentView.type === 'projects') {
                    // Level 0: Show all projects
                    projects.forEach(project => {
                        const projectRuns = testRuns.filter(run => run.projectId === project.projectId);
                        const latestRun = projectRuns[0];
                        console.log(`Project ${project.name} - Latest run:`, latestRun);

                        if (latestRun) {
                            // Use real test run data
                            const totalTests = latestRun.totalTests || 0;
                            const totalPassed = latestRun.passedTests || 0;
                            const totalFailed = latestRun.failedTests || 0;
                            const totalSkipped = latestRun.skippedTests || 0;
                            const totalDuration = latestRun.duration || 1000;
                            
                            console.log(`Project ${project.name} stats:`, {
                                totalTests,
                                totalPassed,
                                totalFailed,
                                totalSkipped,
                                suiteRuns: latestRun.suiteRuns
                            });
                            
                            treemapData.push({
                                name: project.name,
                                value: totalDuration,
                                passed: totalPassed,
                                failed: totalFailed,
                                skipped: totalSkipped,
                                total: totalTests,
                                duration: totalDuration,
                                project: project,
                                testRun: latestRun,
                                suites: latestRun.suiteRuns || [],
                                type: 'project'
                            });
                        }
                    });
                } else if (currentView.type === 'project') {
                    // Level 1: Show suites within a project
                    const project = currentView.data.project;
                    const testRun = currentView.data.testRun;
                    console.log('Project view - testRun:', testRun);
                    console.log('Project view - suiteRuns:', testRun?.suiteRuns);

                    // Fetch real suite data if available
                    if (testRun && testRun.suiteRuns && testRun.suiteRuns.length > 0) {
                        console.log('Mapping suite runs to treemap data');
                        treemapData = testRun.suiteRuns.map(suite => ({
                            name: suite.suiteName,
                            value: suite.duration || 1000,
                            passed: suite.passedSpecs || 0,
                            failed: suite.failedSpecs || 0,
                            skipped: suite.skippedSpecs || 0,
                            total: suite.totalSpecs || 0,
                            duration: suite.duration || 1000,
                            project: project,
                            testRun: testRun,
                            suite: suite,
                            type: 'suite'
                        }));
                    }
                } else if (currentView.type === 'suite') {
                    // Level 2: Show individual tests in a suite
                    const suite = currentView.data.suite;
                    
                    // Use real spec data if available
                    if (suite.specRuns && suite.specRuns.length > 0) {
                        treemapData = suite.specRuns.map(spec => ({
                            name: spec.specName || '[Test]',
                            value: spec.duration || 100, // Size by execution time
                            status: spec.status,
                            duration: spec.duration || 100,
                            message: spec.errorMessage || '',
                            type: 'test'
                        }));
                    } else {
                        // No spec data available
                        treemapData = [{
                            name: 'No test details available',
                            value: 1000,
                            status: 'unknown',
                            duration: 0,
                            message: '',
                            type: 'test'
                        }];
                    }
                }

                if (treemapData.length === 0) return;

                const hierarchy = d3.hierarchy({ children: treemapData })
                    .sum(d => d.value || d.children?.reduce((sum, child) => sum + child.value, 0) || 1)
                    .sort((a, b) => b.value - a.value);

                const treemap = d3.treemap()
                    .size([width - 40, height - 40])
                    .padding(8)
                    .round(true);

                treemap(hierarchy);

                // Create gradients
                const defs = svg.append("defs");
                hierarchy.leaves().forEach((d, i) => {
                    const gradient = defs.append("linearGradient")
                        .attr("id", `gradient-${i}`)
                        .attr("gradientUnits", "objectBoundingBox")
                        .attr("x1", "0%").attr("y1", "0%")
                        .attr("x2", "100%").attr("y2", "100%");

                    let baseColor;
                    if (currentView.type === 'projects' || currentView.type === 'project') {
                        // Project and suite-level coloring based on pass rate
                        baseColor = getTestStatusColor(d.data.passed, d.data.failed, d.data.skipped, d.data.total);
                    } else if (currentView.type === 'suite') {
                        // Individual test coloring based on status
                        baseColor = getStatusColor(d.data.status);
                    }
                    
                    const darkerColor = d3.color(baseColor).darker(0.4);
                    
                    gradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", baseColor);
                    
                    gradient.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", darkerColor);
                });

                // Draw cells
                const cell = svg.selectAll("g")
                    .data(hierarchy.leaves())
                    .enter().append("g")
                    .attr("transform", d => `translate(${d.x0 + 20},${d.y0 + 20})`);

                cell.append("rect")
                    .attr("class", "treemap-cell")
                    .attr("width", d => d.x1 - d.x0)
                    .attr("height", d => d.y1 - d.y0)
                    .attr("fill", (d, i) => `url(#gradient-${i})`)
                    .attr("rx", 8)
                    .style("cursor", currentView.type !== 'suite' ? "pointer" : "default")
                    .on("click", async function(event, d) {
                        if (currentView.type === 'projects' && d.data.type === 'project') {
                            // Fetch detailed test run data with suites
                            try {
                                const detailedData = await window.graphqlClient.query(
                                    window.GRAPHQL_QUERIES.GET_TEST_RUN_DETAILS,
                                    { runId: d.data.testRun.runId }
                                );
                                
                                if (detailedData && detailedData.testRunByRunId) {
                                    const detailedRun = detailedData.testRunByRunId;
                                    // Update the data with actual suite information
                                    d.data.testRun = detailedRun;
                                    d.data.suites = detailedRun.suiteRuns || [];
                                }
                            } catch (error) {
                                console.error('Failed to fetch test run details:', error);
                            }
                            
                            // Navigate to project view (show suites)
                            navigateToView('project', d.data, [
                                { name: 'Projects', type: 'projects', data: null },
                                { name: d.data.project.name, type: 'project', data: d.data }
                            ]);
                        } else if (currentView.type === 'project' && d.data.type === 'suite') {
                            // Navigate to suite view (show individual tests)
                            navigateToView('suite', d.data, [
                                { name: 'Projects', type: 'projects', data: null },
                                { name: d.data.project.name, type: 'project', data: { project: d.data.project } },
                                { name: d.data.suite.name, type: 'suite', data: d.data }
                            ]);
                        }
                    })
                    .on("mouseover", function(event, d) {
                        tooltipMerged.transition().duration(200).style("opacity", .95);
                        
                        let tooltipContent;
                        
                        if (currentView.type === 'projects') {
                            // Project-level tooltip
                            const passRate = d.data.total > 0 ? ((d.data.passed / d.data.total) * 100).toFixed(1) : 0;
                            const duration = (d.data.duration / 1000).toFixed(2);
                            
                            tooltipContent = `
                                <div style="font-weight: 700; margin-bottom: 0.75rem; font-size: 1rem;">${d.data.name}</div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Project Overview</div>
                                <div style="margin-bottom: 0.5rem;">Tests: ${d.data.total} ‚Ä¢ Duration: ${duration}s</div>
                                <div style="margin-bottom: 0.5rem;">‚úÖ ${d.data.passed} ‚Ä¢ ‚ùå ${d.data.failed} ‚Ä¢ ‚è≠Ô∏è ${d.data.skipped}</div>
                                <div style="margin-top: 0.75rem; font-weight: 600; color: ${getTestStatusColor(d.data.passed, d.data.failed, d.data.skipped, d.data.total)};">Pass Rate: ${passRate}%</div>
                                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-tertiary);">Click to view test suites</div>
                            `;
                        } else if (currentView.type === 'project') {
                            // Suite-level tooltip
                            const passRate = d.data.total > 0 ? ((d.data.passed / d.data.total) * 100).toFixed(1) : 0;
                            const duration = (d.data.duration / 1000).toFixed(2);
                            
                            tooltipContent = `
                                <div style="font-weight: 700; margin-bottom: 0.75rem; font-size: 1rem;">${d.data.name}</div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Test Suite</div>
                                <div style="margin-bottom: 0.5rem;">Tests: ${d.data.total} ‚Ä¢ Duration: ${duration}s</div>
                                <div style="margin-bottom: 0.5rem;">‚úÖ ${d.data.passed} ‚Ä¢ ‚ùå ${d.data.failed} ‚Ä¢ ‚è≠Ô∏è ${d.data.skipped}</div>
                                <div style="margin-top: 0.75rem; font-weight: 600; color: ${getTestStatusColor(d.data.passed, d.data.failed, d.data.skipped, d.data.total)};">Pass Rate: ${passRate}%</div>
                                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-tertiary);">Click to view individual tests</div>
                            `;
                        } else if (currentView.type === 'suite') {
                            // Individual test tooltip
                            const duration = (d.data.duration / 1000).toFixed(3);
                            const statusIcon = d.data.status === 'passed' ? '‚úÖ' : d.data.status === 'failed' ? '‚ùå' : '‚è≠Ô∏è';
                            const statusColor = getStatusColor(d.data.status);
                            
                            tooltipContent = `
                                <div style="font-weight: 700; margin-bottom: 0.75rem; font-size: 1rem;">${d.data.name}</div>
                                <div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${statusIcon}</span>
                                    <span style="font-weight: 600; color: ${statusColor}; text-transform: uppercase;">${d.data.status}</span>
                                </div>
                                <div style="margin-bottom: 0.5rem;">Duration: ${duration}s</div>
                                ${d.data.message ? `<div style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--error); font-style: italic;">${d.data.message}</div>` : ''}
                            `;
                        }
                        
                        tooltipMerged.html(tooltipContent)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mouseout", function() {
                        tooltipMerged.transition().duration(300).style("opacity", 0);
                    });

                // Add text labels
                cell.append("text")
                    .attr("class", "treemap-text-project")
                    .attr("x", 12)
                    .attr("y", 28)
                    .text(d => {
                        const maxLength = Math.floor((d.x1 - d.x0) / 9);
                        return d.data.name.length > maxLength ? 
                            d.data.name.substring(0, maxLength - 3) + "..." : 
                            d.data.name;
                    });

                cell.filter(d => (d.x1 - d.x0) > 120 && (d.y1 - d.y0) > 70)
                    .append("text")
                    .attr("class", "treemap-text-count")
                    .attr("x", 12)
                    .attr("y", d => (d.y1 - d.y0) - 12)
                    .text(d => `${d.data.total} tests ‚Ä¢ ${(d.data.duration / 1000).toFixed(1)}s`);

            }, [projects, testRuns, currentView]);

            if (!projects.length) {
                return (
                    <div className="treemap-container">
                        <div className="empty-state">
                            <i className="fas fa-chart-bar"></i>
                            <h3>No projects available</h3>
                            <p>Create projects to see the interactive treemap visualization</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="treemap-container fade-in">
                    {breadcrumb.length > 0 && (
                        <div className="breadcrumb">
                            {breadcrumb.map((item, index) => (
                                <React.Fragment key={index}>
                                    <div 
                                        className={`breadcrumb-item ${index === breadcrumb.length - 1 ? 'active' : ''}`}
                                        onClick={() => {
                                            if (index < breadcrumb.length - 1) {
                                                // Navigate to the clicked breadcrumb level
                                                const targetItem = breadcrumb[index];
                                                if (targetItem.type === 'projects') {
                                                    navigateToView('projects', null, []);
                                                } else if (targetItem.type === 'project') {
                                                    navigateToView('project', targetItem.data, breadcrumb.slice(0, index + 1));
                                                }
                                            }
                                        }}
                                    >
                                        <i className={index === 0 ? 'fas fa-home' : index === breadcrumb.length - 1 ? 'fas fa-flask' : 'fas fa-folder-open'}></i>
                                        {item.name}
                                    </div>
                                    {index < breadcrumb.length - 1 && (
                                        <div className="breadcrumb-separator">
                                            <i className="fas fa-chevron-right" style={{fontSize: '0.75rem'}}></i>
                                        </div>
                                    )}
                                </React.Fragment>
                            ))}
                        </div>
                    )}
                    <div className="treemap-title">
                        <h3>
                            {currentView.type === 'projects' && 'Project Overview'}
                            {currentView.type === 'project' && `Test Suites: ${currentView.data.project.name}`}
                            {currentView.type === 'suite' && `Individual Tests: ${currentView.data.suite.name}`}
                        </h3>
                        <p>
                            {currentView.type === 'projects' && 'Project-level test performance ‚Ä¢ Size represents total execution time ‚Ä¢ Color indicates overall pass rate'}
                            {currentView.type === 'project' && 'Test suite performance within project ‚Ä¢ Size represents execution time ‚Ä¢ Color indicates pass rate'}
                            {currentView.type === 'suite' && 'Individual test execution times and results ‚Ä¢ Size shows execution time ‚Ä¢ Color shows pass/fail status'}
                        </p>
                    </div>
                    <svg ref={svgRef} className="treemap-svg"></svg>
                    <div className="treemap-legend">
                        {(currentView.type === 'projects' || currentView.type === 'project') ? (
                            <>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#10b981'}}></div>
                                    <span>High Pass Rate (90%+)</span>
                                </div>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#34d399'}}></div>
                                    <span>Good Pass Rate (70-89%)</span>
                                </div>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#f59e0b'}}></div>
                                    <span>Medium Pass Rate (50-69%)</span>
                                </div>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#ef4444'}}></div>
                                    <span>Low Pass Rate (&lt;50%)</span>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#10b981'}}></div>
                                    <span>Passed Tests</span>
                                </div>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#ef4444'}}></div>
                                    <span>Failed Tests</span>
                                </div>
                                <div className="legend-item">
                                    <div className="legend-color" style={{background: '#6b7280'}}></div>
                                    <span>Skipped Tests</span>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Enhanced Dashboard component
        function Dashboard() {
            const [health, setHealth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [testRuns, setTestRuns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dashboardSummary, setDashboardSummary] = useState(null);

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    const data = await graphqlClient.query(GRAPHQL_QUERIES.GET_DASHBOARD_DATA);
                    
                    // Extract data from GraphQL response
                    setHealth(data.dashboardSummary.health);
                    
                    // Convert projects from edges format
                    const projectList = data.projects.edges.map(edge => edge.node);
                    setProjects(projectList);
                    
                    // Set test runs with project names
                    const testRunsWithProjects = (data.recentTestRuns || []).map(run => {
                        const project = projectList.find(p => p.projectId === run.projectId);
                        return {
                            ...run,
                            projectName: project?.name || run.projectId
                        };
                    });
                    setTestRuns(testRunsWithProjects);
                    
                    // Store dashboard summary for later use
                    setDashboardSummary(data.dashboardSummary);
                    
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading fade-in">
                            <i className="fas fa-spinner"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Loading dashboard...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error-message fade-in">
                            <i className="fas fa-exclamation-triangle"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Error: {error}</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container fade-in">
                    <div className="dashboard-grid">
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">
                                    <div className="card-icon" style={{color: 'var(--success)'}}>
                                        <i className="fas fa-heartbeat"></i>
                                    </div>
                                    Platform Health
                                </h3>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Service Status</span>
                                <span className={`status ${health?.status === 'healthy' ? 'healthy' : 'inactive'}`}>
                                    {health?.status || 'Unknown'}
                                </span>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Service</span>
                                <span className="stat-number">{health?.service || 'fern-platform'}</span>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Last Updated</span>
                                <span style={{fontWeight: '600', color: 'var(--text-secondary)'}}>
                                    {health?.timestamp ? formatDate(health.timestamp) : 'N/A'}
                                </span>
                            </div>
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">
                                    <div className="card-icon" style={{color: 'var(--primary)'}}>
                                        <i className="fas fa-folder-open"></i>
                                    </div>
                                    Projects
                                </h3>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Total Projects</span>
                                <span className="stat-number">{projects.length}</span>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Active Projects</span>
                                <span className="stat-number success">{projects.filter(p => p.isActive).length}</span>
                            </div>
                            {projects.length === 0 && (
                                <div className="empty-state" style={{padding: '2rem 1rem'}}>
                                    <i className="fas fa-plus-circle" style={{fontSize: '2rem', marginBottom: '0.75rem'}}></i>
                                    <p style={{fontSize: '0.875rem'}}>No projects found. Create your first project via API.</p>
                                </div>
                            )}
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">
                                    <div className="card-icon" style={{color: 'var(--info)'}}>
                                        <i className="fas fa-play-circle"></i>
                                    </div>
                                    Test Runs
                                </h3>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Total Runs</span>
                                <span className="stat-number">{testRuns.length}</span>
                            </div>
                            <div className="stat-row">
                                <span style={{fontWeight: '500'}}>Recent Runs (24h)</span>
                                <span className="stat-number info">{testRuns.filter(tr => {
                                    const runDate = new Date(tr.startTime);
                                    const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                                    return runDate > dayAgo;
                                }).length}</span>
                            </div>
                            {testRuns.length === 0 && (
                                <div className="empty-state" style={{padding: '2rem 1rem'}}>
                                    <i className="fas fa-rocket" style={{fontSize: '2rem', marginBottom: '0.75rem'}}></i>
                                    <p style={{fontSize: '0.875rem'}}>No test runs found. Submit test results via API.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <h3 className="card-title">
                                <div className="card-icon" style={{color: 'var(--accent)'}}>
                                    <i className="fas fa-code"></i>
                                </div>
                                API Endpoints
                            </h3>
                        </div>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem'}}>
                            {[
                                { method: 'GET', endpoint: '/health', desc: 'Service health check' },
                                { method: 'GET', endpoint: '/api/v1/projects', desc: 'List all projects' },
                                { method: 'POST', endpoint: '/api/v1/projects', desc: 'Create new project' },
                                { method: 'GET', endpoint: '/api/v1/test-runs', desc: 'List all test runs' },
                                { method: 'POST', endpoint: '/api/v1/test-runs', desc: 'Create new test run' },
                                { method: 'GET', endpoint: '/graphql', desc: 'GraphQL playground' }
                            ].map((api, index) => (
                                <div key={index} style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '1rem',
                                    padding: '1rem',
                                    background: 'var(--bg-secondary)',
                                    border: '1px solid var(--border-light)',
                                    borderRadius: 'var(--radius-lg)',
                                    fontSize: '0.875rem',
                                    transition: 'all var(--transition-fast)'
                                }}>
                                    <span style={{
                                        background: api.method === 'GET' ? 'var(--info)' : 'var(--primary)',
                                        color: 'white',
                                        padding: '0.375rem 0.75rem',
                                        borderRadius: 'var(--radius-md)',
                                        fontSize: '0.75rem',
                                        fontWeight: '700',
                                        minWidth: '55px',
                                        textAlign: 'center'
                                    }}>
                                        {api.method}
                                    </span>
                                    <code style={{
                                        fontFamily: 'Monaco, Consolas, monospace', 
                                        color: 'var(--text-primary)',
                                        fontWeight: '500',
                                        background: 'var(--bg-tertiary)',
                                        padding: '0.25rem 0.5rem',
                                        borderRadius: 'var(--radius-sm)',
                                        fontSize: '0.8rem'
                                    }}>
                                        {api.endpoint}
                                    </code>
                                    <span style={{color: 'var(--text-secondary)', fontSize: '0.8rem'}}>
                                        {api.desc}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Project Treemap Component with Drill-down
        function ProjectTreemap({ project, testRuns, timeRange }) {
            const svgRef = useRef();
            const [currentView, setCurrentView] = useState('suites'); // 'suites' or 'specs'
            const [selectedSuite, setSelectedSuite] = useState(null);
            const [tooltip, setTooltip] = useState({ show: false, x: 0, y: 0, content: null });

            useEffect(() => {
                if (!project || !testRuns) return;

                const container = svgRef.current.parentNode;
                const width = container.clientWidth - 16; // Account for padding
                const height = (container.clientHeight || 320) - 16; // Account for padding

                // Clear previous content
                d3.select(svgRef.current).selectAll("*").remove();

                const svg = d3.select(svgRef.current)
                    .attr("viewBox", [0, 0, width, height])
                    .attr("width", width)
                    .attr("height", height);

                // Get recent test runs for this project
                const cutoffDate = timeRange ? new Date() : null;
                if (cutoffDate && timeRange) {
                    cutoffDate.setDate(cutoffDate.getDate() - timeRange);
                }
                
                const projectRuns = testRuns
                    .filter(run => {
                        if (run.projectId !== project.projectId) return false;
                        if (cutoffDate && timeRange) {
                            const runDate = new Date(run.startTime);
                            return runDate >= cutoffDate;
                        }
                        return true;
                    })
                    .slice(-5); // Last 5 runs within time range

                if (projectRuns.length === 0) {
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .style("fill", "var(--text-secondary)")
                        .text("No test data available");
                    return;
                }

                // Aggregate suite data from recent runs
                const suiteMap = new Map();
                
                projectRuns.forEach(run => {
                    if (run.suiteRuns && run.suiteRuns.length > 0) {
                        run.suiteRuns.forEach(suite => {
                            const key = suite.suiteName;
                            if (!suiteMap.has(key)) {
                                suiteMap.set(key, {
                                    name: suite.suiteName,
                                    totalSpecs: 0,
                                    passedSpecs: 0,
                                    failedSpecs: 0,
                                    skippedSpecs: 0,
                                    duration: 0,
                                    specRuns: []
                                });
                            }
                            const suiteData = suiteMap.get(key);
                            suiteData.totalSpecs += suite.totalSpecs || 0;
                            suiteData.passedSpecs += suite.passedSpecs || 0;
                            suiteData.failedSpecs += suite.failedSpecs || 0;
                            suiteData.skippedSpecs += suite.skippedSpecs || 0;
                            suiteData.duration += suite.duration || 0;
                            if (suite.specRuns) {
                                suiteData.specRuns.push(...suite.specRuns);
                            }
                        });
                    }
                });

                if (currentView === 'specs' && selectedSuite) {
                    // Show specs for selected suite
                    const suiteData = suiteMap.get(selectedSuite);
                    if (!suiteData || !suiteData.specRuns || suiteData.specRuns.length === 0) {
                        svg.append("text")
                            .attr("x", width / 2)
                            .attr("y", height / 2)
                            .attr("text-anchor", "middle")
                            .style("fill", "var(--text-secondary)")
                            .text("No spec data available");
                        return;
                    }

                    // Aggregate spec data
                    const specMap = new Map();
                    suiteData.specRuns.forEach(spec => {
                        const key = spec.specName;
                        if (!specMap.has(key)) {
                            specMap.set(key, {
                                name: spec.specName,
                                passCount: 0,
                                failCount: 0,
                                totalDuration: 0,
                                runs: 0
                            });
                        }
                        const specData = specMap.get(key);
                        specData.runs++;
                        specData.totalDuration += spec.duration || 0;
                        if (spec.status === 'passed') {
                            specData.passCount++;
                        } else if (spec.status === 'failed') {
                            specData.failCount++;
                        }
                    });

                    const specData = Array.from(specMap.values()).map(spec => ({
                        name: spec.name,
                        value: spec.totalDuration || 1,
                        passRate: spec.runs > 0 ? spec.passCount / spec.runs : 0,
                        avgDuration: spec.runs > 0 ? spec.totalDuration / spec.runs : 0,
                        runs: spec.runs
                    }));

                    const hierarchicalData = {
                        name: selectedSuite,
                        children: specData
                    };

                    renderTreemap(hierarchicalData, 'spec');
                } else {
                    // Show suites view
                    const suiteData = Array.from(suiteMap.values()).map(suite => ({
                        name: suite.name,
                        value: suite.duration || 1,
                        totalSpecs: suite.totalSpecs,
                        passedSpecs: suite.passedSpecs,
                        failedSpecs: suite.failedSpecs,
                        passRate: suite.totalSpecs > 0 ? suite.passedSpecs / suite.totalSpecs : 0
                    }));

                    const hierarchicalData = {
                        name: project.name,
                        children: suiteData
                    };

                    renderTreemap(hierarchicalData, 'suite');
                }

                function renderTreemap(data, type) {
                    const root = d3.hierarchy(data)
                        .sum(d => d.value)
                        .sort((a, b) => b.value - a.value);

                    d3.treemap()
                        .size([width, height])
                        .paddingOuter(2)
                        .paddingTop(2)
                        .paddingInner(1)
                        .paddingBottom(2)
                        .round(true)(root);

                    const colorScale = d3.scaleSequential(d3.interpolateRdYlGn)
                        .domain([0, 1]);

                    const nodes = root.leaves();
                    
                    const cell = svg.selectAll("g")
                        .data(nodes)
                        .join("g")
                        .attr("transform", d => `translate(${d.x0},${d.y0})`);

                    cell.append("rect")
                        .attr("width", d => d.x1 - d.x0)
                        .attr("height", d => d.y1 - d.y0)
                        .attr("fill", d => colorScale(d.data.passRate || 0))
                        .attr("stroke", "var(--bg-primary)")
                        .attr("stroke-width", 1)
                        .style("cursor", type === 'suite' ? "pointer" : "default")
                        .on("click", function(event, d) {
                            if (type === 'suite') {
                                setSelectedSuite(d.data.name);
                                setCurrentView('specs');
                            }
                        })
                        .on("mouseover", function(event, d) {
                            const rect = this.getBoundingClientRect();
                            setTooltip({
                                show: true,
                                x: rect.left + rect.width / 2,
                                y: rect.top - 10,
                                content: d.data
                            });
                        })
                        .on("mouseout", () => {
                            setTooltip({ show: false, x: 0, y: 0, content: null });
                        });

                    // Add text labels
                    cell.append("text")
                        .attr("x", d => (d.x1 - d.x0) / 2)
                        .attr("y", d => (d.y1 - d.y0) / 2)
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "middle")
                        .style("font-size", d => {
                            const width = d.x1 - d.x0;
                            const height = d.y1 - d.y0;
                            return Math.min(width / 10, height / 4, 14) + "px";
                        })
                        .style("fill", d => {
                            const passRate = d.data.passRate || 0;
                            return passRate > 0.5 ? "rgba(0, 0, 0, 0.8)" : "rgba(255, 255, 255, 0.9)";
                        })
                        .style("font-weight", "600")
                        .style("pointer-events", "none")
                        .text(d => {
                            const width = d.x1 - d.x0;
                            const name = d.data.name;
                            if (width < 60) return "";
                            if (width < 100) return name.substring(0, 10) + "...";
                            return name;
                        });

                    // Add pass rate percentage
                    if (type === 'suite') {
                        cell.append("text")
                            .attr("x", d => (d.x1 - d.x0) / 2)
                            .attr("y", d => d.y1 - d.y0 - 10)
                            .attr("text-anchor", "middle")
                            .style("font-size", "11px")
                            .style("fill", d => {
                                const passRate = d.data.passRate || 0;
                                return passRate > 0.5 ? "rgba(0, 0, 0, 0.6)" : "rgba(255, 255, 255, 0.7)";
                            })
                            .style("pointer-events", "none")
                            .text(d => {
                                const width = d.x1 - d.x0;
                                if (width < 50) return "";
                                return `${(d.data.passRate * 100).toFixed(0)}%`;
                            });
                    }
                }
            }, [project, testRuns, currentView, selectedSuite, timeRange]);

            return (
                <>
                    {currentView === 'specs' && (
                        <div className="breadcrumb-nav">
                            <button onClick={() => {
                                setCurrentView('suites');
                                setSelectedSuite(null);
                            }}>
                                {project.name}
                            </button>
                            <span>‚Ä∫</span>
                            <span>{selectedSuite}</span>
                        </div>
                    )}
                    <div className="project-treemap-container">
                        <svg ref={svgRef} style={{ width: '100%', height: '100%' }}></svg>
                    </div>
                    {tooltip.show && tooltip.content && (
                        <div className="treemap-tooltip" style={{
                            position: 'fixed',
                            left: tooltip.x,
                            top: tooltip.y,
                            transform: 'translate(-50%, -100%)'
                        }}>
                            <div style={{ fontWeight: '600', marginBottom: '0.25rem' }}>
                                {tooltip.content.name}
                            </div>
                            {currentView === 'suites' ? (
                                <div style={{ fontSize: '0.75rem' }}>
                                    <div>Pass Rate: {((tooltip.content.passRate || 0) * 100).toFixed(1)}%</div>
                                    <div>Total Specs: {tooltip.content.totalSpecs || 0}</div>
                                    <div>Duration: {((tooltip.content.value || 0) / 1000).toFixed(1)}s</div>
                                </div>
                            ) : (
                                <div style={{ fontSize: '0.75rem' }}>
                                    <div>Pass Rate: {((tooltip.content.passRate || 0) * 100).toFixed(1)}%</div>
                                    <div>Avg Duration: {tooltip.content.avgDuration ? tooltip.content.avgDuration.toFixed(0) : 0}ms</div>
                                    <div>Runs: {tooltip.content.runs}</div>
                                </div>
                            )}
                        </div>
                    )}
                </>
            );
        }

        // Enhanced Test Summaries component
        function TestSummaries() {
            const [projects, setProjects] = useState([]);
            const [testRuns, setTestRuns] = useState([]);
            const [treemapData, setTreemapData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showHistory, setShowHistory] = useState(false);
            const [selectedProject, setSelectedProject] = useState(null);

            // User preferences integration
            const userPrefs = useUserPreferences();
            const {
                preferences,
                toggleFavorite,
                isFavorite,
                setShowFavoritesOnly,
                sortProjects,
                filterProjects
            } = userPrefs;

            const [viewMode, setViewMode] = useState(preferences?.defaultTestSummariesView || 'grid');
            const [flippedCards, setFlippedCards] = useState(new Set());
            const [timeRange, setTimeRange] = useState(7); // Default to 7 days

            const showProjectHistory = (project) => {
                setSelectedProject(project);
                setShowHistory(true);
            };
            
            const toggleCardFlip = (projectId) => {
                setFlippedCards(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(projectId)) {
                        newSet.delete(projectId);
                    } else {
                        newSet.add(projectId);
                    }
                    return newSet;
                });
            };
            
            const hideProjectHistory = () => {
                setShowHistory(false);
                setSelectedProject(null);
            };

            useEffect(() => {
                fetchData();
            }, [timeRange]); // Re-fetch when time range changes

            // Update view mode when preferences change
            useEffect(() => {
                if (preferences?.defaultTestSummariesView) {
                    setViewMode(preferences.defaultTestSummariesView);
                }
            }, [preferences?.defaultTestSummariesView]);

            const fetchData = async () => {
                try {
                    // Fetch both dashboard data and treemap data
                    const [dashboardData, treemapResponse] = await Promise.all([
                        graphqlClient.query(GRAPHQL_QUERIES.GET_DASHBOARD_DATA),
                        graphqlClient.query(GRAPHQL_QUERIES.GET_TREEMAP_DATA, { days: timeRange })
                    ]);
                    
                    // Convert projects from edges format
                    const projectList = dashboardData.projects.edges.map(edge => edge.node);
                    setProjects(projectList);
                    
                    // Set test runs with project names
                    const testRunsWithProjects = (dashboardData.recentTestRuns || []).map(run => {
                        const project = projectList.find(p => p.projectId === run.projectId);
                        return {
                            ...run,
                            projectName: project?.name || run.projectId
                        };
                    });
                    setTestRuns(testRunsWithProjects);
                    
                    // Store treemap data for accurate counts
                    setTreemapData(treemapResponse.treemapData);
                    
                    setLoading(false);
                } catch (err) {
                    console.error('Error fetching test summaries data:', err);
                    setError(err.message);
                    setLoading(false);
                }
            };

            // Apply user preferences to projects
            const getDisplayProjects = () => {
                if (!projects || projects.length === 0) return [];
                
                let displayProjects = [...projects];
                
                // First filter by favorites if enabled (with null safety)
                if (filterProjects && typeof filterProjects === 'function') {
                    displayProjects = filterProjects(displayProjects);
                }
                
                // Then sort according to preferences (with null safety)
                if (sortProjects && typeof sortProjects === 'function') {
                    displayProjects = sortProjects(displayProjects);
                }
                
                return displayProjects;
            };

            const handleStarClick = (e, projectId) => {
                e.stopPropagation(); // Prevent card click events
                
                // Don't allow favoriting projects without valid IDs
                if (!projectId || projectId === '') {
                    return;
                }
                
                toggleFavorite(projectId);
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading fade-in">
                            <i className="fas fa-spinner"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Loading test summaries...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error-message fade-in">
                            <i className="fas fa-exclamation-triangle"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Error: {error}</div>
                        </div>
                    </div>
                );
            }

            // Show test history chart if selected
            if (showHistory && selectedProject) {
                return <TestHistoryChart 
                    project={selectedProject} 
                    testRuns={testRuns} 
                    onBack={hideProjectHistory} 
                />;
            }

            return (
                <div className="container fade-in">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '1.5rem'}}>
                            <h2 style={{color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em', margin: 0}}>
                                <i className="fas fa-chart-pie" style={{marginRight: '0.75rem', color: 'var(--primary)'}}></i>
                                Test Summaries
                            </h2>
                            
                            {preferences?.favorites?.length > 0 && (
                                <button 
                                    className={`toggle-button ${preferences?.showFavoritesOnly ? 'active' : ''}`}
                                    onClick={() => setShowFavoritesOnly(!preferences?.showFavoritesOnly)}
                                    style={{fontSize: '0.875rem', padding: '0.5rem 1rem', minWidth: 'auto'}}
                                >
                                    <i className="fas fa-star"></i>
                                    {preferences?.showFavoritesOnly ? 'Show All' : `Favorites (${preferences?.favorites?.length || 0})`}
                                </button>
                            )}
                        </div>
                        
                        <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                            <select 
                                value={timeRange} 
                                onChange={(e) => setTimeRange(Number(e.target.value))}
                                style={{
                                    background: 'var(--bg-elevated)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: 'var(--radius-md)',
                                    color: 'var(--text-primary)',
                                    padding: '0.5rem 2.5rem 0.5rem 0.75rem',
                                    fontSize: '0.875rem',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    appearance: 'none',
                                    backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M5.998 7.5L2.25 3.75h7.5L5.998 7.5z'/%3E%3C/svg%3E")`,
                                    backgroundRepeat: 'no-repeat',
                                    backgroundPosition: 'right 0.5rem center',
                                    backgroundSize: '12px'
                                }}
                            >
                                <option value={7}>Last 7 days</option>
                                <option value={30}>Last 1 month</option>
                                <option value={180}>Last 6 months</option>
                                <option value={365}>Last 1 year</option>
                            </select>
                            <div className="view-toggle">
                            <button 
                                className={`toggle-button ${viewMode === 'grid' ? 'active' : ''}`}
                                onClick={() => {
                                    setFlippedCards(new Set());
                                    setViewMode('grid');
                                }}
                            >
                                <i className="fas fa-th-large"></i>
                                Card View
                            </button>
                            <button 
                                className={`toggle-button ${viewMode === 'treemap' ? 'active' : ''}`}
                                onClick={() => {
                                    if (viewMode === 'grid') {
                                        // Flip all cards to treemap view
                                        const allProjectIds = getDisplayProjects().map(p => p.id);
                                        setFlippedCards(new Set(allProjectIds));
                                        setViewMode('treemap');
                                    } else {
                                        // Unflip all cards and go back to grid view
                                        setFlippedCards(new Set());
                                        setViewMode('grid');
                                    }
                                }}
                            >
                                <i className="fas fa-chart-bar"></i>
                                Treemap View
                            </button>
                        </div>
                        </div>
                    </div>

                    {(viewMode === 'grid' || viewMode === 'treemap') && getDisplayProjects().length > 0 && (
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(400px, 1fr))', gap: '2.5rem', rowGap: '3rem'}}>
                            {getDisplayProjects().map(project => {
                                // Get stats from treemap data for consistency with Manager Dashboard
                                let totalTests = 0;
                                let passedTests = 0;
                                let failedTests = 0;
                                let totalRuns = 0;
                                
                                if (treemapData && treemapData.projects) {
                                    const projectData = treemapData.projects.find(p => p.project.projectId === project.projectId);
                                    if (projectData) {
                                        totalTests = projectData.totalTests || 0;
                                        // Calculate passed/failed from pass rate
                                        passedTests = Math.round(totalTests * (projectData.passRate || 0));
                                        failedTests = totalTests - passedTests;
                                        // Use the totalRuns from treemap data which respects the time range filter
                                        totalRuns = projectData.totalRuns || 0;
                                    }
                                }

                                const isFlipped = viewMode === 'treemap' || flippedCards.has(project.id);
                                
                                return (
                                    <div key={project.id} className="card-flip-container">
                                        <div className={`card-flipper ${isFlipped ? 'flipped' : ''}`}>
                                            {/* Front of card */}
                                            <div className="card-front">
                                                <div className="card">
                                        <div className="card-header">
                                            <div style={{display: 'flex', alignItems: 'flex-start', gap: '0.75rem', flex: 1}}>
                                                <div style={{flex: 1}}>
                                                    <h3 style={{margin: '0 0 0.5rem 0', color: 'var(--text-primary)', fontSize: '1.25rem', fontWeight: '600'}}>
                                                        {project.name}
                                                    </h3>
                                                    <p style={{margin: 0, color: 'var(--text-secondary)', fontSize: '0.875rem'}}>
                                                        {project.description || 'No description provided'}
                                                    </p>
                                                </div>
                                                {(project.project_id || project.id) && (
                                                    <button
                                                        onClick={(e) => handleStarClick(e, project.project_id || project.id)}
                                                        className={`star-button ${isFavorite(project.project_id || project.id) ? 'favorite' : ''}`}
                                                        title={isFavorite(project.project_id || project.id) ? 'Remove from favorites' : 'Add to favorites'}
                                                        style={{
                                                            background: 'none',
                                                            border: 'none',
                                                            cursor: 'pointer',
                                                            padding: '0.5rem',
                                                            borderRadius: '50%',
                                                            transition: 'all 0.2s ease',
                                                            fontSize: '1.25rem',
                                                            color: isFavorite(project.project_id || project.id) ? '#fbbf24' : '#9ca3af'
                                                        }}
                                                        onMouseEnter={(e) => e.target.style.background = 'var(--bg-secondary)'}
                                                        onMouseLeave={(e) => e.target.style.background = 'none'}
                                                    >
                                                        <i className={`${isFavorite(project.project_id || project.id) ? 'fas' : 'far'} fa-star`}></i>
                                                    </button>
                                                )}
                                            </div>
                                            <span className={`status ${project.is_active ? 'active' : 'inactive'}`}>
                                                {project.is_active ? 'Active' : 'Inactive'}
                                            </span>
                                        </div>

                                        <div style={{marginBottom: '1.5rem'}}>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem', marginBottom: '1rem'}}>
                                                <div style={{textAlign: 'center', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', border: '1px solid var(--border-light)'}}>
                                                    <div style={{fontSize: '1.5rem', fontWeight: '700', color: 'var(--text-primary)'}}>{totalTests}</div>
                                                    <div style={{fontSize: '0.75rem', color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Total Tests</div>
                                                </div>
                                                <div style={{textAlign: 'center', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', border: '1px solid var(--border-light)'}}>
                                                    <div style={{fontSize: '1.5rem', fontWeight: '700', color: 'var(--text-primary)'}}>{totalRuns}</div>
                                                    <div style={{fontSize: '0.75rem', color: 'var(--text-tertiary)', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Test Runs</div>
                                                </div>
                                            </div>
                                            
                                            <div style={{display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap', marginBottom: '1rem'}}>
                                                <span style={{fontSize: '0.875rem', fontWeight: '500'}}>
                                                    <span className="success" style={{fontSize: '1.125rem', fontWeight: '700'}}>{passedTests}</span> passed
                                                </span>
                                                <span style={{fontSize: '0.875rem', fontWeight: '500'}}>
                                                    <span className="error" style={{fontSize: '1.125rem', fontWeight: '700'}}>{failedTests}</span> failed
                                                </span>
                                            </div>
                                            
                                            <div style={{borderTop: '1px solid #e2e8f0', paddingTop: '1rem'}}>
                                                <button 
                                                    onClick={() => showProjectHistory(project)}
                                                    style={{
                                                        width: '100%',
                                                        background: '#10b981',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '8px',
                                                        padding: '12px 16px',
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        cursor: 'pointer',
                                                        fontFamily: 'Inter, sans-serif'
                                                    }}
                                                >
                                                    üìä View Test History
                                                </button>
                                            </div>
                                        </div>
                                                </div>
                                            </div>
                                            
                                            {/* Back of card */}
                                            <div className="card-back">
                                                <div className="treemap-header">
                                                    <h3 className="treemap-title">{project.name} - Test Suites</h3>
                                                </div>
                                                <div style={{flex: 1, minHeight: '320px', maxHeight: '340px', overflow: 'hidden', position: 'relative', padding: '0 0.5rem 1.5rem 0.5rem'}}>
                                                    <ProjectTreemap project={project} testRuns={testRuns} timeRange={timeRange} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {getDisplayProjects().length === 0 && projects.length > 0 && preferences?.showFavoritesOnly && (
                        <div className="empty-state">
                            <i className="fas fa-star"></i>
                            <h3>No favorite projects</h3>
                            <p>Star some projects to add them to your favorites list.</p>
                        </div>
                    )}
                    
                    {projects.length === 0 && (
                        <div className="empty-state">
                            <i className="fas fa-folder-open"></i>
                            <h3>No projects found</h3>
                            <p>Create your first project to see comprehensive test summaries and visualizations here.</p>
                        </div>
                    )}
                </div>
            );
        }

        // Enhanced Test Runs component with drill-down functionality
        function TestRuns() {
            const [testRuns, setTestRuns] = useState([]);
            const [selectedRun, setSelectedRun] = useState(null);
            const [selectedSuite, setSelectedSuite] = useState(null);
            const [suiteData, setSuiteData] = useState([]);
            const [specData, setSpecData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [view, setView] = useState('runs'); // 'runs', 'suites', 'specs'

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    const data = await graphqlClient.query(GRAPHQL_QUERIES.GET_DASHBOARD_DATA);
                    
                    // Get projects to map project names
                    const projectList = data.projects.edges.map(edge => edge.node);
                    console.log('Projects loaded:', projectList);
                    console.log('Test runs:', data.recentTestRuns);
                    
                    // Enrich test runs with project names
                    const enrichedTestRuns = (data.recentTestRuns || []).map(run => {
                        const project = projectList.find(p => p.projectId === run.projectId);
                        console.log(`Looking for project ${run.projectId}, found:`, project);
                        return {
                            ...run,
                            projectName: project?.name || run.projectId
                        };
                    });
                    
                    setTestRuns(enrichedTestRuns);
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };



            // Extract real suite data from test run metadata
            const extractSuitesFromMetadata = (suiteRuns, testRun) => {
                return suiteRuns.map(suiteRun => {
                    // Calculate suite statistics from spec runs
                    let totalTests = 0;
                    let passedTests = 0;
                    let failedTests = 0;
                    let skippedTests = 0;
                    
                    suiteRun.specRuns.forEach(specRun => {
                        totalTests++;
                        switch (specRun.status) {
                            case 'passed':
                                passedTests++;
                                break;
                            case 'failed':
                                failedTests++;
                                break;
                            case 'skipped':
                            case 'pending':
                                skippedTests++;
                                break;
                        }
                    });

                    // Calculate duration from start/end times
                    let duration = 0;
                    if (suiteRun.start_time && suiteRun.end_time) {
                        const start = new Date(suiteRun.start_time);
                        const end = new Date(suiteRun.end_time);
                        duration = end.getTime() - start.getTime();
                    }

                    // Determine overall suite status
                    let status = 'passed';
                    if (failedTests > 0) {
                        status = 'failed';
                    } else if (skippedTests > 0) {
                        status = 'passed_with_skipped';
                    }

                    return {
                        id: suiteRun.id,
                        name: suiteRun.suite_name,
                        totalTests: totalTests,
                        passedTests: passedTests,
                        failedTests: failedTests,
                        skippedTests: skippedTests,
                        duration_ms: duration,
                        status: status,
                        test_run_id: testRun.id,
                        specRuns: suiteRun.specRuns // Store the real spec data
                    };
                });
            };

            const handleRunClick = async (run) => {
                setSelectedRun(run);
                setSelectedSuite(null);
                
                // Try to get detailed test run data with suite runs from API
                let suites = [];
                
                try {
                    // Use GraphQL to fetch test run details
                    const data = await window.graphqlClient.query(
                        window.GRAPHQL_QUERIES.GET_TEST_RUN_DETAILS,
                        { runId: run.runId }
                    );
                    
                    if (data && data.testRunByRunId) {
                        const detailedRun = data.testRunByRunId;
                        console.log('Fetched detailed run via GraphQL:', detailedRun);
                        
                        // Use the actual suiteRuns relationship from GraphQL
                        if (detailedRun.suiteRuns && detailedRun.suiteRuns.length > 0) {
                            suites = detailedRun.suiteRuns.map(suiteRun => ({
                                id: suiteRun.id,
                                name: suiteRun.suiteName,
                                totalTests: suiteRun.totalSpecs,
                                passedTests: suiteRun.passedSpecs,
                                failedTests: suiteRun.failedSpecs,
                                skippedTests: suiteRun.skippedSpecs,
                                duration_ms: suiteRun.duration,
                                status: suiteRun.status,
                                test_run_id: run.id,
                                specRuns: suiteRun.specRuns || []
                            }));
                        } else if (detailedRun.metadata && detailedRun.metadata.suite_runs) {
                            // Fallback to metadata if no database relationships exist
                            console.log('Falling back to metadata suiteRuns');
                            suites = extractSuitesFromMetadata(detailedRun.metadata.suite_runs, run);
                        }
                    }
                } catch (error) {
                    console.warn('Failed to fetch detailed test run data:', error);
                }
                
                // Show error if no real data available
                if (suites.length === 0) {
                    console.warn('No real suite data found for:', run.projectName || run.projectId);
                    setError(`No test suite data available for this test run. The run may not have been properly reported by fern-ginkgo-client.`);
                    return;
                }
                
                setSuiteData(suites);
                setView('suites');
            };

            // Extract real spec data from suite metadata
            const extractSpecsFromMetadata = (specRuns) => {
                return specRuns.map((specRun, index) => {
                    // Calculate duration from start/end times
                    let duration = 0;
                    if (specRun.start_time && specRun.end_time) {
                        const start = new Date(specRun.start_time);
                        const end = new Date(specRun.end_time);
                        duration = end.getTime() - start.getTime();
                    }

                    return {
                        id: specRun.id || index + 1,
                        name: specRun.spec_description,
                        status: specRun.status,
                        duration_ms: duration,
                        error_message: specRun.message || null,
                        suite_id: specRun.suite_id,
                        started_at: specRun.start_time,
                        finished_at: specRun.end_time,
                        tags: specRun.tags || []
                    };
                });
            };

            const handleSuiteClick = (suite) => {
                setSelectedSuite(suite);
                
                let specs = [];
                
                // Use real spec data from database relationships or metadata
                if (suite.specRuns && suite.specRuns.length > 0) {
                    // Map database SpecRun entities to our spec format
                    specs = suite.specRuns.map((specRun, index) => {
                        console.log('Spec run data:', specRun);
                        return {
                            id: specRun.id || index + 1,
                            name: specRun.specName || '[Unnamed Spec]',
                            status: specRun.status,
                            duration_ms: specRun.duration,
                            error_message: specRun.errorMessage || null,
                            suite_id: suite.id,
                            started_at: specRun.startTime,
                            finished_at: specRun.endTime,
                            startTime: specRun.startTime,  // Add both for compatibility
                            tags: []
                        };
                    });
                } else {
                    // Show error if no real spec data available
                    console.warn('No real spec data found for suite:', suite.name);
                    setError(`No test spec data available for this suite. The suite may not have been properly reported by fern-ginkgo-client.`);
                    return;
                }
                
                setSpecData(specs);
                setView('specs');
            };

            const handleBackToRuns = () => {
                setSelectedRun(null);
                setSelectedSuite(null);
                setSuiteData([]);
                setSpecData([]);
                setView('runs');
            };

            const handleBackToSuites = () => {
                setSelectedSuite(null);
                setSpecData([]);
                setView('suites');
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading fade-in">
                            <i className="fas fa-spinner"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Loading test runs...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error-message fade-in">
                            <i className="fas fa-exclamation-triangle"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Error: {error}</div>
                        </div>
                    </div>
                );
            }

            // Breadcrumb navigation
            const renderBreadcrumb = () => {
                if (view === 'runs') return null;
                
                return (
                    <div className="breadcrumb">
                        <button onClick={handleBackToRuns}>
                            <i className="fas fa-home"></i> Test Runs
                        </button>
                        {view === 'suites' && (
                            <>
                                <span className="breadcrumb-separator">‚ñ∂</span>
                                <span>{selectedRun?.projectName || selectedRun?.projectId || '-'} - {selectedRun?.runId || '-'}</span>
                            </>
                        )}
                        {view === 'specs' && (
                            <>
                                <span className="breadcrumb-separator">‚ñ∂</span>
                                <button onClick={handleBackToSuites}>
                                    {selectedRun?.projectName || selectedRun?.projectId || '-'} - {selectedRun?.runId || '-'}
                                </button>
                                <span className="breadcrumb-separator">‚ñ∂</span>
                                <span>{selectedSuite?.name}</span>
                            </>
                        )}
                    </div>
                );
            };

            // Test Runs List View
            if (view === 'runs') {
                return (
                    <div className="container fade-in">
                        <h2 style={{marginBottom: '2rem', color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em'}}>
                            <i className="fas fa-list-alt" style={{marginRight: '0.75rem', color: 'var(--primary)'}}></i>
                            Test Runs
                        </h2>
                        
                        {testRuns.length > 0 ? (
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Project</th>
                                            <th>Run ID</th>
                                            <th>Branch</th>
                                            <th>Test Results</th>
                                            <th>Status</th>
                                            <th>Duration</th>
                                            <th>Started</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {testRuns.map((run) => (
                                            <tr key={run.id} 
                                                onClick={() => handleRunClick(run)}
                                                style={{cursor: 'pointer'}}
                                                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'var(--bg-secondary)'}
                                                onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                            >
                                                <td>
                                                    <div style={{fontWeight: '600', fontSize: '0.875rem'}}>{run.projectName || run.projectId}</div>
                                                    <div style={{fontSize: '0.75rem', color: 'var(--text-tertiary)'}}>
                                                        {run.environment || 'default'}
                                                    </div>
                                                </td>
                                                <td>
                                                    <code style={{fontSize: '0.75rem', background: 'var(--bg-tertiary)', padding: '0.375rem 0.75rem', borderRadius: 'var(--radius-md)', fontWeight: '500'}}>
                                                        {run.runId}
                                                    </code>
                                                </td>
                                                <td>
                                                    <span style={{display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.875rem', fontWeight: '500'}}>
                                                        <i className="fas fa-code-branch" style={{fontSize: '0.75rem', color: 'var(--text-tertiary)'}}></i>
                                                        {run.branch || 'main'}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center', fontSize: '0.875rem', fontWeight: '500'}}>
                                                        <span className="success">{run.passedTests || 0}</span>
                                                        <span className="error">{run.failedTests || 0}</span>
                                                        <span className="muted">{run.skippedTests || 0}</span>
                                                    </div>
                                                    <div style={{fontSize: '0.75rem', color: 'var(--text-tertiary)', marginTop: '0.25rem'}}>
                                                        {run.totalTests || 0} total tests
                                                    </div>
                                                </td>
                                                <td>
                                                    <span className={`status ${run.status === 'completed' ? 'healthy' : 'active'}`}>
                                                        {run.status}
                                                    </span>
                                                </td>
                                                <td style={{fontWeight: '500'}}>
                                                    {run.duration ? `${(run.duration / 1000).toFixed(1)}s` : 'N/A'}
                                                </td>
                                                <td style={{fontWeight: '500', color: 'var(--text-secondary)'}}>{formatDate(run.startTime)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="empty-state">
                                <i className="fas fa-flask"></i>
                                <h3>No test runs found</h3>
                                <p>Test runs will appear here once you submit test results via the API. Get started by running your first test suite.</p>
                            </div>
                        )}
                    </div>
                );
            }

            // Test Suites View
            if (view === 'suites') {
                return (
                    <div className="container fade-in">
                        {renderBreadcrumb()}
                        <h2 style={{marginBottom: '2rem', color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em'}}>
                            <i className="fas fa-folder-open" style={{marginRight: '0.75rem', color: 'var(--primary)'}}></i>
                            Test Suites for {selectedRun?.projectName || selectedRun?.projectId}
                        </h2>
                        <div style={{marginBottom: '1.5rem', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', border: '1px solid var(--border-light)'}}>
                            <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)'}}>
                                <strong>Run ID:</strong> {selectedRun?.runId} | 
                                <strong> Branch:</strong> {selectedRun?.branch || 'main'} | 
                                <strong> Environment:</strong> {selectedRun?.environment || 'default'}
                            </div>
                        </div>
                        
                        <div className="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Suite Name</th>
                                        <th>Test Results</th>
                                        <th>Status</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {suiteData.map((suite) => (
                                        <tr key={suite.id}
                                            onClick={() => handleSuiteClick(suite)}
                                            style={{cursor: 'pointer'}}
                                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'var(--bg-secondary)'}
                                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                        >
                                            <td>
                                                <div style={{fontWeight: '600', fontSize: '0.875rem'}}>{suite.name}</div>
                                            </td>
                                            <td>
                                                <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center', fontSize: '0.875rem', fontWeight: '500'}}>
                                                    <span className="success">{suite.passedTests}</span>
                                                    <span className="error">{suite.failedTests}</span>
                                                    <span className="muted">{suite.skippedTests}</span>
                                                </div>
                                                <div style={{fontSize: '0.75rem', color: 'var(--text-tertiary)', marginTop: '0.25rem'}}>
                                                    {suite.totalTests} total tests
                                                </div>
                                            </td>
                                            <td>
                                                <span className={`status ${suite.status === 'passed' ? 'healthy' : suite.status === 'failed' ? 'error' : 'warning'}`}>
                                                    {suite.status === 'passed_with_skipped' ? 'passed' : suite.status}
                                                </span>
                                            </td>
                                            <td style={{fontWeight: '500'}}>
                                                {(suite.duration_ms / 1000).toFixed(1)}s
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            // Test Specs View
            if (view === 'specs') {
                return (
                    <div className="container fade-in">
                        {renderBreadcrumb()}
                        <h2 style={{marginBottom: '2rem', color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em'}}>
                            <i className="fas fa-flask" style={{marginRight: '0.75rem', color: 'var(--primary)'}}></i>
                            Test Specs for {selectedSuite?.name}
                        </h2>
                        <div style={{marginBottom: '1.5rem', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', border: '1px solid var(--border-light)'}}>
                            <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)'}}>
                                <strong>Project:</strong> {selectedRun?.projectName || selectedRun?.projectId} | 
                                <strong> Run ID:</strong> {selectedRun?.runId} | 
                                <strong> Suite:</strong> {selectedSuite?.name}
                            </div>
                        </div>
                        
                        <div className="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Status</th>
                                        <th>Duration</th>
                                        <th>Error Message</th>
                                        <th>Started</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {specData.map((spec) => (
                                        <tr key={spec.id}>
                                            <td>
                                                <div style={{fontWeight: '600', fontSize: '0.875rem'}}>{spec.name}</div>
                                            </td>
                                            <td>
                                                <span className={`status ${spec.status === 'passed' ? 'healthy' : spec.status === 'failed' ? 'error' : 'warning'}`}>
                                                    {spec.status}
                                                </span>
                                            </td>
                                            <td style={{fontWeight: '500'}}>
                                                {spec.duration_ms}ms
                                            </td>
                                            <td>
                                                {spec.error_message ? (
                                                    <code style={{fontSize: '0.75rem', background: 'var(--bg-tertiary)', padding: '0.375rem 0.75rem', borderRadius: 'var(--radius-md)', color: 'var(--error)', maxWidth: '300px', display: 'block', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                                        {spec.error_message}
                                                    </code>
                                                ) : (
                                                    <span style={{color: 'var(--text-tertiary)', fontSize: '0.875rem'}}>-</span>
                                                )}
                                            </td>
                                            <td style={{fontWeight: '500', color: 'var(--text-secondary)'}}>{formatDate(spec.startTime || spec.started_at)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }
        }

        // Manager Dashboard Component
        function ManagerDashboard() {
            const [projects, setProjects] = useState([]);
            const [testRuns, setTestRuns] = useState([]);
            const [treemapData, setTreemapData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [timeRange, setTimeRange] = useState(7); // Default to 7 days

            // User preferences integration
            const userPrefs = useUserPreferences();
            const { preferences, updateManagerDashboard } = userPrefs;

            useEffect(() => {
                fetchData();
            }, [timeRange]); // Re-fetch when time range changes

            const fetchData = async () => {
                try {
                    const data = await graphqlClient.query(GRAPHQL_QUERIES.GET_DASHBOARD_DATA);
                    console.log('Manager Dashboard Data:', data);
                    
                    // Convert projects from edges format
                    const projectList = data.projects.edges.map(edge => edge.node);
                    console.log('Projects:', projectList);
                    setProjects(projectList);
                    
                    // Set test runs with project names
                    const testRunsWithProjects = (data.recentTestRuns || []).map(run => {
                        const project = projectList.find(p => p.projectId === run.projectId);
                        console.log('Test run:', run);
                        console.log('Suite runs for test run:', run.suiteRuns);
                        return {
                            ...run,
                            projectName: project?.name || run.projectId
                        };
                    });
                    setTestRuns(testRunsWithProjects);
                    
                    // Fetch treemap data
                    try {
                        console.log(`Fetching treemap data for ${timeRange} days...`);
                        const treemapResponse = await graphqlClient.query(GRAPHQL_QUERIES.GET_TREEMAP_DATA, { days: timeRange });
                        console.log('Treemap data response:', treemapResponse);
                        if (treemapResponse && treemapResponse.treemapData) {
                            console.log('Setting treemap data:', treemapResponse.treemapData);
                            setTreemapData(treemapResponse.treemapData);
                        } else {
                            console.log('No treemap data in response');
                        }
                    } catch (treemapErr) {
                        console.error('Error fetching treemap data:', treemapErr);
                        // Continue without treemap data
                    }
                    
                    setLoading(false);
                } catch (err) {
                    console.error('Error fetching manager dashboard data:', err);
                    setError(err.message);
                    setLoading(false);
                }
            };

            // Get selected projects for the uber treemap
            const getSelectedProjects = () => {
                if (preferences.managerDashboard.selectedProjects.length === 0) {
                    return projects; // Show all projects if none selected
                }
                return projects.filter(project => 
                    preferences.managerDashboard.selectedProjects.includes(project.id) ||
                    preferences.managerDashboard.selectedProjects.includes(project.projectId)
                );
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading fade-in">
                            <i className="fas fa-spinner"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Loading manager dashboard...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error-message fade-in">
                            <i className="fas fa-exclamation-triangle"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Error: {error}</div>
                        </div>
                    </div>
                );
            }

            const selectedProjects = getSelectedProjects();
            console.log('Manager Dashboard - projects:', projects);
            console.log('Manager Dashboard - preferences:', preferences.managerDashboard);
            console.log('Manager Dashboard - selectedProjects:', selectedProjects);
            console.log('Manager Dashboard - treemapData:', treemapData);

            if (selectedProjects.length === 0) {
                return (
                    <div className="container fade-in">
                        <h2 style={{color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em', marginBottom: '2rem'}}>
                            <i className="fas fa-tachometer-alt" style={{marginRight: '0.75rem', color: 'var(--primary)'}}></i>
                            Manager Dashboard
                        </h2>
                        
                        <div className="empty-state">
                            <i className="fas fa-tachometer-alt"></i>
                            <h3>No projects selected</h3>
                            <p>Go to Settings ‚Üí Manager Dashboard to select which projects to include in your uber treemap view.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container fade-in">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2 style={{color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em', margin: 0}}>
                            <i className="fas fa-tachometer-alt" style={{marginRight: '0.75rem', color: 'var(--primary)'}}></i>
                            Manager Dashboard
                        </h2>
                        <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                            <select 
                                value={timeRange} 
                                onChange={(e) => setTimeRange(Number(e.target.value))}
                                style={{
                                    background: 'var(--bg-elevated)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: 'var(--radius-md)',
                                    color: 'var(--text-primary)',
                                    padding: '0.5rem 2.5rem 0.5rem 0.75rem',
                                    fontSize: '0.875rem',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    appearance: 'none',
                                    backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M5.998 7.5L2.25 3.75h7.5L5.998 7.5z'/%3E%3C/svg%3E")`,
                                    backgroundRepeat: 'no-repeat',
                                    backgroundPosition: 'right 0.5rem center',
                                    backgroundSize: '12px'
                                }}
                            >
                                <option value={1}>Last 24 hours</option>
                                <option value={7}>Last 7 days</option>
                                <option value={14}>Last 14 days</option>
                                <option value={30}>Last 30 days</option>
                                <option value={90}>Last 90 days</option>
                            </select>
                            <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)', fontWeight: '500'}}>
                                {selectedProjects.length} project{selectedProjects.length !== 1 ? 's' : ''} ‚Ä¢ Aggregated View
                            </div>
                        </div>
                    </div>

                    <div style={{
                        background: 'var(--bg-elevated)',
                        border: '1px solid var(--border-light)',
                        borderRadius: 'var(--radius-xl)',
                        padding: '2rem',
                        marginBottom: '2rem',
                        boxShadow: 'var(--shadow-lg)'
                    }}>
                        <div style={{textAlign: 'center', marginBottom: '2rem'}}>
                            <h3 style={{color: 'var(--text-primary)', fontSize: '1.5rem', fontWeight: '600', margin: '0 0 0.5rem 0'}}>
                                Aggregated Project Status
                            </h3>
                            <p style={{color: 'var(--text-secondary)', fontSize: '0.875rem', margin: 0}}>
                                Unified view of all selected projects for high-level oversight
                            </p>
                        </div>
                        
                        {treemapData ? (
                            <>
                                <UberTreemap treemapData={{
                                    ...treemapData,
                                    projects: preferences.managerDashboard.selectedProjects.length > 0 
                                        ? treemapData.projects.filter(p => 
                                            preferences.managerDashboard.selectedProjects.includes(p.project.id) ||
                                            preferences.managerDashboard.selectedProjects.includes(p.project.projectId)
                                          )
                                        : treemapData.projects
                                }} />
                                <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)', fontSize: '0.75rem', color: 'var(--text-tertiary)'}}>
                                    <strong>Debug Info:</strong> UberTreemap using aggregated data from TreemapData query (last {timeRange} days)<br/>
                                    Total Projects in Data: {treemapData.projects.length}<br/>
                                    Projects Shown: {preferences.managerDashboard.selectedProjects.length > 0 
                                        ? treemapData.projects.filter(p => 
                                            preferences.managerDashboard.selectedProjects.includes(p.project.id) ||
                                            preferences.managerDashboard.selectedProjects.includes(p.project.projectId)
                                          ).length
                                        : treemapData.projects.length}<br/>
                                    Total Tests ({timeRange} days): {treemapData.totalTests}<br/>
                                    Overall Pass Rate ({timeRange} days): {(treemapData.overallPassRate * 100).toFixed(1)}%<br/>
                                    <em>Note: Failed count includes skipped tests due to backend aggregation</em>
                                </div>
                            </>
                        ) : (
                            <>
                                <TreemapVisualization 
                                    projects={selectedProjects} 
                                    testRuns={testRuns}
                                    title="Manager Overview"
                                />
                                <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)', fontSize: '0.75rem', color: 'var(--text-tertiary)'}}>
                                    <strong>Debug Info:</strong> TreemapVisualization using recent test runs only
                                </div>
                            </>
                        )}
                    </div>

                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem'}}>
                        {selectedProjects.map(project => {
                            const projectRuns = testRuns.filter(run => run.projectId === project.projectId);
                            const latestRun = projectRuns[0];
                            const totalTests = projectRuns.reduce((sum, run) => sum + (run.totalTests || 0), 0);
                            const passedTests = projectRuns.reduce((sum, run) => sum + (run.passedTests || 0), 0);
                            const failedTests = projectRuns.reduce((sum, run) => sum + (run.failedTests || 0), 0);

                            return (
                                <div key={project.id} className="card" style={{background: 'var(--bg-elevated)'}}>
                                    <div className="card-header">
                                        <div>
                                            <h3 style={{margin: '0 0 0.5rem 0', color: 'var(--text-primary)', fontSize: '1.125rem', fontWeight: '600'}}>
                                                {project.name}
                                            </h3>
                                            <p style={{margin: 0, color: 'var(--text-secondary)', fontSize: '0.75rem'}}>
                                                {projectRuns.length} total runs
                                            </p>
                                        </div>
                                        <span className={`status ${latestRun?.status === 'completed' ? 'healthy' : 'active'}`}>
                                            {latestRun?.status || 'No runs'}
                                        </span>
                                    </div>

                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '0.75rem', marginTop: '1rem'}}>
                                        <div style={{textAlign: 'center', padding: '0.75rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)'}}>
                                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: 'var(--text-primary)'}}>{totalTests}</div>
                                            <div style={{fontSize: '0.625rem', color: 'var(--text-tertiary)', textTransform: 'uppercase'}}>Total</div>
                                        </div>
                                        <div style={{textAlign: 'center', padding: '0.75rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)'}}>
                                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: 'var(--success)'}}>{passedTests}</div>
                                            <div style={{fontSize: '0.625rem', color: 'var(--text-tertiary)', textTransform: 'uppercase'}}>Passed</div>
                                        </div>
                                        <div style={{textAlign: 'center', padding: '0.75rem', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)'}}>
                                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: 'var(--error)'}}>{failedTests}</div>
                                            <div style={{fontSize: '0.625rem', color: 'var(--text-tertiary)', textTransform: 'uppercase'}}>Failed</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Admin Pages Components

        // Admin Users Management Page
        function AdminUsers() {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                fetchUsers();
            }, []);

            const fetchUsers = async () => {
                try {
                    const response = await fetch('/api/v1/admin/users', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setUsers(data.users || []);
                    } else {
                        setError('Failed to load users');
                    }
                } catch (err) {
                    setError('Error loading users: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const updateUserRole = async (userId, newRole) => {
                try {
                    const response = await fetch(`/api/v1/admin/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ role: newRole })
                    });
                    if (response.ok) {
                        fetchUsers(); // Refresh the list
                    } else {
                        setError('Failed to update user role');
                    }
                } catch (err) {
                    setError('Error updating user: ' + err.message);
                }
            };

            if (loading) return <div className="page-container"><div style={{textAlign: 'center', padding: '2rem'}}>Loading users...</div></div>;
            if (error) return <div className="page-container"><div style={{textAlign: 'center', padding: '2rem', color: 'var(--error)'}}>{error}</div></div>;

            return (
                <div className="page-container">
                    <div className="page-header">
                        <h1>üë• User Management</h1>
                        <p>Manage user accounts and permissions</p>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <h3>All Users</h3>
                            <span className="badge">{users.length} users</span>
                        </div>

                        <div style={{overflow: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                <thead>
                                    <tr style={{borderBottom: '1px solid var(--border-color)'}}>
                                        <th style={{textAlign: 'left', padding: '1rem', color: 'var(--text-secondary)', fontWeight: '600'}}>User</th>
                                        <th style={{textAlign: 'left', padding: '1rem', color: 'var(--text-secondary)', fontWeight: '600'}}>Role</th>
                                        <th style={{textAlign: 'left', padding: '1rem', color: 'var(--text-secondary)', fontWeight: '600'}}>Status</th>
                                        <th style={{textAlign: 'left', padding: '1rem', color: 'var(--text-secondary)', fontWeight: '600'}}>Last Login</th>
                                        <th style={{textAlign: 'left', padding: '1rem', color: 'var(--text-secondary)', fontWeight: '600'}}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {users.map(user => (
                                        <tr key={user.user_id} style={{borderBottom: '1px solid var(--border-color)'}}>
                                            <td style={{padding: '1rem'}}>
                                                <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                                                    <div style={{
                                                        width: '32px', height: '32px', borderRadius: '50%',
                                                        background: user.profile_url ? `url(${user.profile_url})` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                        backgroundSize: 'cover', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                        fontSize: '14px', fontWeight: '600', color: 'white'
                                                    }}>
                                                        {!user.profile_url && (user.name ? user.name.charAt(0).toUpperCase() : 'üë§')}
                                                    </div>
                                                    <div>
                                                        <div style={{fontWeight: '600', color: 'var(--text-primary)'}}>{user.name}</div>
                                                        <div style={{fontSize: '0.875rem', color: 'var(--text-secondary)'}}>{user.email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style={{padding: '1rem'}}>
                                                <select 
                                                    value={user.role} 
                                                    onChange={(e) => updateUserRole(user.user_id, e.target.value)}
                                                    style={{
                                                        background: 'var(--bg-secondary)', border: '1px solid var(--border-color)',
                                                        borderRadius: '4px', padding: '0.25rem 0.5rem', color: 'var(--text-primary)'
                                                    }}
                                                >
                                                    <option value="user">User</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                            </td>
                                            <td style={{padding: '1rem'}}>
                                                <span className={`status ${user.status === 'active' ? 'healthy' : 'inactive'}`}>
                                                    {user.status}
                                                </span>
                                            </td>
                                            <td style={{padding: '1rem', color: 'var(--text-secondary)', fontSize: '0.875rem'}}>
                                                {user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}
                                            </td>
                                            <td style={{padding: '1rem'}}>
                                                <button 
                                                    onClick={() => console.log('Edit user:', user.user_id)}
                                                    style={{
                                                        background: 'var(--primary)', color: 'white', border: 'none',
                                                        borderRadius: '4px', padding: '0.25rem 0.5rem', cursor: 'pointer',
                                                        fontSize: '0.875rem'
                                                    }}
                                                >
                                                    Edit
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // Admin Projects Management Page
        function AdminProjects() {
            return (
                <div className="page-container">
                    <div className="page-header">
                        <h1>üìÅ Project Management</h1>
                        <p>Manage projects and access controls</p>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <h3>Projects</h3>
                            <button style={{
                                background: 'var(--primary)', color: 'white', border: 'none',
                                borderRadius: '4px', padding: '0.5rem 1rem', cursor: 'pointer'
                            }}>
                                + Create Project
                            </button>
                        </div>
                        <div style={{textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)'}}>
                            Project management interface coming soon...
                        </div>
                    </div>
                </div>
            );
        }

        // Admin System Settings Page
        function AdminSystem() {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchSystemStats();
            }, []);

            const fetchSystemStats = async () => {
                try {
                    const response = await fetch('/api/v1/admin/system/stats', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setStats(data);
                    }
                } catch (err) {
                    console.error('Failed to fetch system stats:', err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="page-container">
                    <div className="page-header">
                        <h1>‚öôÔ∏è System Administration</h1>
                        <p>System statistics and maintenance tools</p>
                    </div>

                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem', marginBottom: '2rem'}}>
                        <div className="card">
                            <div className="card-header">
                                <h3>System Stats</h3>
                            </div>
                            {loading ? (
                                <div style={{textAlign: 'center', padding: '1rem'}}>Loading...</div>
                            ) : stats ? (
                                <div style={{display: 'grid', gap: '1rem'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <span>Total Users:</span>
                                        <strong>{stats.total_users}</strong>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <span>Total Projects:</span>
                                        <strong>{stats.total_projects}</strong>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <span>Total Test Runs:</span>
                                        <strong>{stats.total_test_runs}</strong>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <span>Active Sessions:</span>
                                        <strong>{stats.active_sessions}</strong>
                                    </div>
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '1rem', color: 'var(--text-secondary)'}}>
                                    No data available
                                </div>
                            )}
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <h3>Quick Actions</h3>
                            </div>
                            <div style={{display: 'grid', gap: '0.5rem'}}>
                                <button style={{
                                    background: 'var(--primary)', color: 'white', border: 'none',
                                    borderRadius: '4px', padding: '0.75rem', cursor: 'pointer', textAlign: 'left'
                                }}>
                                    üßπ Run System Cleanup
                                </button>
                                <button style={{
                                    background: 'var(--secondary)', color: 'white', border: 'none',
                                    borderRadius: '4px', padding: '0.75rem', cursor: 'pointer', textAlign: 'left'
                                }}>
                                    üìä Generate Report
                                </button>
                                <button style={{
                                    background: 'var(--warning)', color: 'white', border: 'none',
                                    borderRadius: '4px', padding: '0.75rem', cursor: 'pointer', textAlign: 'left'
                                }}>
                                    üîß Maintenance Mode
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Access Denied Component
        function AccessDenied() {
            return (
                <div className="page-container">
                    <div style={{textAlign: 'center', padding: '4rem'}}>
                        <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üö´</div>
                        <h1 style={{color: 'var(--error)', marginBottom: '1rem'}}>Access Denied</h1>
                        <p style={{color: 'var(--text-secondary)', marginBottom: '2rem'}}>
                            You don't have permission to access this page.
                        </p>
                        <button 
                            onClick={() => window.location.href = '/'}
                            style={{
                                background: 'var(--primary)', color: 'white', border: 'none',
                                borderRadius: '8px', padding: '0.75rem 1.5rem', cursor: 'pointer'
                            }}
                        >
                            Go to Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // Project Management Component for Managers
        function ProjectManagement() {
            const { user, userTeams, isAdmin, isManager } = useAuth();
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [deletingProject, setDeletingProject] = useState(null);
            const [deleteConfirmInput, setDeleteConfirmInput] = useState('');

            useEffect(() => {
                fetchProjects();
            }, []);

            const fetchProjects = async () => {
                try {
                    setLoading(true);
                    const data = await graphqlClient.query(GRAPHQL_QUERIES.GET_DASHBOARD_DATA);
                    const projectList = data.projects.edges.map(edge => edge.node);
                    setProjects(projectList);
                    setLoading(false);
                } catch (err) {
                    console.error('Error fetching projects:', err);
                    setError(err.message);
                    setLoading(false);
                }
            };

            const handleCreateProject = async (projectData) => {
                try {
                    await graphqlClient.mutation(GRAPHQL_QUERIES.CREATE_PROJECT, {
                        input: {
                            projectId: '', // Empty string - will be auto-generated
                            ...projectData
                        }
                    });
                    setShowCreateModal(false);
                    fetchProjects();
                } catch (err) {
                    console.error('Error creating project:', err);
                    alert('Failed to create project: ' + err.message);
                }
            };

            const handleUpdateProject = async (projectId, projectData) => {
                console.log('Update project called with ID:', projectId, 'Data:', projectData);
                try {
                    console.log('Calling UPDATE_PROJECT mutation');
                    console.log('Full mutation variables:', {
                        id: projectId,
                        input: projectData
                    });
                    const result = await graphqlClient.mutation(GRAPHQL_QUERIES.UPDATE_PROJECT, {
                        id: projectId,
                        input: projectData
                    });
                    console.log('Update result:', result);
                    setEditingProject(null);
                    fetchProjects();
                } catch (err) {
                    console.error('Error updating project:', err);
                    console.error('Error stack:', err.stack);
                    alert('Failed to update project: ' + err.message);
                }
            };

            const handleDeleteProject = async (projectId, projectName) => {
                console.log('Delete project called with ID:', projectId);
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    setDeletingProject(project);
                    setDeleteConfirmInput('');
                }
            };

            const confirmDeleteProject = async () => {
                if (!deletingProject) return;
                
                if (deleteConfirmInput !== deletingProject.name) {
                    alert('Project name does not match. Please type the exact project name.');
                    return;
                }
                
                try {
                    console.log('Calling DELETE_PROJECT mutation with ID:', deletingProject.id);
                    console.log('Full mutation variables:', { id: deletingProject.id });
                    const result = await graphqlClient.mutation(GRAPHQL_QUERIES.DELETE_PROJECT, {
                        id: deletingProject.id
                    });
                    console.log('Delete result:', result);
                    setDeletingProject(null);
                    setDeleteConfirmInput('');
                    fetchProjects();
                } catch (err) {
                    console.error('Error deleting project:', err);
                    console.error('Error stack:', err.stack);
                    alert('Failed to delete project: ' + err.message);
                }
            };

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading fade-in">
                            <i className="fas fa-spinner"></i>
                            <div style={{fontSize: '1.125rem', fontWeight: '500', marginTop: '1rem'}}>Loading projects...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error-state">
                            <i className="fas fa-exclamation-triangle"></i>
                            <h3>Error loading projects</h3>
                            <p>{error}</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container fade-in">
                    <div style={{marginBottom: '2rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <h2 style={{color: 'var(--text-primary)', fontSize: '2rem', fontWeight: '700', letterSpacing: '-0.025em'}}>
                            <span style={{marginRight: '0.75rem', color: 'var(--primary)'}}>üìÅ</span>
                            Project Management
                        </h2>
                        {isManager && (
                            <button 
                                onClick={() => setShowCreateModal(true)}
                                style={{
                                background: 'var(--primary)',
                                color: 'white',
                                border: 'none',
                                padding: '0.75rem 1.5rem',
                                borderRadius: 'var(--radius-lg)',
                                cursor: 'pointer',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem',
                                transition: 'all 0.2s ease',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.background = 'var(--primary-dark)';
                                e.target.style.transform = 'translateY(-1px)';
                                e.target.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.background = 'var(--primary)';
                                e.target.style.transform = 'translateY(0)';
                                e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                            }}
                        >
                            <span>‚ûï</span>
                            New Project
                        </button>
                        )}
                    </div>

                    <div style={{
                        background: 'var(--bg-elevated)',
                        borderRadius: 'var(--radius-xl)',
                        border: '1px solid var(--border-light)',
                        overflow: 'hidden',
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.07)'
                    }}>
                        <table style={{
                            width: '100%',
                            borderCollapse: 'collapse',
                            fontSize: '0.875rem'
                        }}>
                            <thead>
                                <tr style={{
                                    background: 'var(--bg-secondary)',
                                    borderBottom: '2px solid var(--border-medium)'
                                }}>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'left',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Project ID</th>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'left',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Name</th>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'left',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Description</th>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'left',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Team</th>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'center',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Status</th>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'center',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Stats</th>
                                    <th style={{
                                        padding: '1rem',
                                        textAlign: 'center',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        fontSize: '0.8125rem',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em'
                                    }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {projects.length === 0 ? (
                                    <tr>
                                        <td colSpan="7" style={{
                                            padding: '3rem',
                                            textAlign: 'center',
                                            color: 'var(--text-secondary)'
                                        }}>
                                            <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>üì≠</div>
                                            <div>No projects found. Create your first project to get started!</div>
                                        </td>
                                    </tr>
                                ) : (
                                    projects.map((project, index) => (
                                        <tr key={`project-${project.id || project.projectId || index}`} style={{
                                            borderBottom: index === projects.length - 1 ? 'none' : '1px solid var(--border-light)',
                                            transition: 'background-color 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'var(--bg-tertiary)'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                        >
                                            <td style={{
                                                padding: '1rem',
                                                fontFamily: 'monospace',
                                                fontSize: '0.8125rem',
                                                color: 'var(--text-primary)'
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '0.5rem'
                                                }}>
                                                    <span style={{color: 'var(--primary)'}}>üîë</span>
                                                    {project.projectId || 'N/A'}
                                                </div>
                                            </td>
                                            <td style={{
                                                padding: '1rem',
                                                fontWeight: '600',
                                                color: 'var(--text-primary)'
                                            }}>
                                                {project.name}
                                            </td>
                                            <td style={{
                                                padding: '1rem',
                                                color: 'var(--text-secondary)',
                                                maxWidth: '300px',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis',
                                                whiteSpace: 'nowrap'
                                            }}>
                                                {project.description || <span style={{fontStyle: 'italic', color: 'var(--text-tertiary)'}}>No description</span>}
                                            </td>
                                            <td style={{
                                                padding: '1rem',
                                                color: 'var(--text-primary)'
                                            }}>
                                                <span style={{
                                                    background: 'var(--bg-secondary)',
                                                    padding: '0.25rem 0.75rem',
                                                    borderRadius: 'var(--radius-md)',
                                                    fontSize: '0.8125rem',
                                                    border: '1px solid var(--border-light)',
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '0.25rem'
                                                }}>
                                                    <span>üë•</span>
                                                    {project.team || 'Unassigned'}
                                                </span>
                                            </td>
                                            <td style={{padding: '1rem', textAlign: 'center'}}>
                                                <span className={`status ${project.isActive ? 'healthy' : 'warning'}`} style={{
                                                    padding: '0.375rem 0.75rem',
                                                    borderRadius: 'var(--radius-md)',
                                                    fontSize: '0.75rem',
                                                    fontWeight: '600',
                                                    textTransform: 'uppercase',
                                                    letterSpacing: '0.025em'
                                                }}>
                                                    {project.isActive ? '‚úÖ Active' : '‚ö†Ô∏è Inactive'}
                                                </span>
                                            </td>
                                            <td style={{padding: '1rem', textAlign: 'center'}}>
                                                {project.stats ? (
                                                    <div style={{
                                                        display: 'flex',
                                                        gap: '1rem',
                                                        justifyContent: 'center',
                                                        alignItems: 'center',
                                                        fontSize: '0.75rem'
                                                    }}>
                                                        <div title="Test Runs">
                                                            <span style={{color: 'var(--text-tertiary)'}}>üèÉ</span>
                                                            <span style={{marginLeft: '0.25rem', fontWeight: '600'}}>{project.stats.totalTestRuns}</span>
                                                        </div>
                                                        <div title="Success Rate">
                                                            <span style={{color: 'var(--success)'}}>‚úì</span>
                                                            <span style={{marginLeft: '0.25rem', fontWeight: '600', color: 'var(--success)'}}>{project.stats.successRate?.toFixed(1)}%</span>
                                                        </div>
                                                        <div title="Avg Duration">
                                                            <span style={{color: 'var(--text-tertiary)'}}>‚è±Ô∏è</span>
                                                            <span style={{marginLeft: '0.25rem', fontWeight: '600'}}>{(project.stats.averageDuration / 1000).toFixed(1)}s</span>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <span style={{color: 'var(--text-tertiary)', fontSize: '0.75rem'}}>No data</span>
                                                )}
                                            </td>
                                            <td style={{padding: '1rem', textAlign: 'center'}}>
                                                {project.canManage ? (
                                                    <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'center'}}>
                                                        <button
                                                            onClick={(e) => {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                                console.log('Edit button clicked for project:', project.id, project.name);
                                                                setEditingProject(project);
                                                            }}
                                                            title="Edit Project"
                                                            style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-light)',
                                                                borderRadius: 'var(--radius-md)',
                                                                padding: '0.5rem 0.75rem',
                                                                cursor: 'pointer',
                                                                color: 'var(--text-secondary)',
                                                                transition: 'all 0.2s ease',
                                                                fontSize: '0.875rem'
                                                            }}
                                                            onMouseEnter={(e) => {
                                                                e.target.style.background = 'var(--primary)';
                                                                e.target.style.color = 'white';
                                                                e.target.style.borderColor = 'var(--primary)';
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                e.target.style.background = 'var(--bg-secondary)';
                                                                e.target.style.color = 'var(--text-secondary)';
                                                                e.target.style.borderColor = 'var(--border-light)';
                                                            }}
                                                        >
                                                            ‚úèÔ∏è
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                                console.log('Delete button clicked for project:', project.id, project.name);
                                                                handleDeleteProject(project.id);
                                                            }}
                                                            title="Delete Project"
                                                            style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-light)',
                                                                borderRadius: 'var(--radius-md)',
                                                                padding: '0.5rem 0.75rem',
                                                                cursor: 'pointer',
                                                                color: 'var(--text-secondary)',
                                                                transition: 'all 0.2s ease',
                                                                fontSize: '0.875rem'
                                                            }}
                                                            onMouseEnter={(e) => {
                                                                e.target.style.background = 'var(--error)';
                                                                e.target.style.color = 'white';
                                                                e.target.style.borderColor = 'var(--error)';
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                e.target.style.background = 'var(--bg-secondary)';
                                                                e.target.style.color = 'var(--text-secondary)';
                                                                e.target.style.borderColor = 'var(--border-light)';
                                                            }}
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <span style={{color: 'var(--text-tertiary)', fontSize: '0.75rem'}}>View only</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* Create/Edit Project Modal */}
                    {(showCreateModal || editingProject) && (
                        <ProjectModal
                            project={editingProject}
                            teams={userTeams}
                            isAdmin={isAdmin}
                            onSubmit={editingProject ? 
                                (data) => handleUpdateProject(editingProject.id, data) : 
                                handleCreateProject
                            }
                            onClose={() => {
                                setShowCreateModal(false);
                                setEditingProject(null);
                            }}
                        />
                    )}

                    {/* Delete Confirmation Modal */}
                    {deletingProject && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.5)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1000
                        }}>
                            <div style={{
                                background: 'var(--bg-primary)',
                                borderRadius: 'var(--radius-xl)',
                                padding: '2rem',
                                maxWidth: '500px',
                                width: '90%',
                                boxShadow: 'var(--shadow-xl)',
                                border: '2px solid var(--error)'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    marginBottom: '1.5rem',
                                    color: 'var(--error)'
                                }}>
                                    <span style={{fontSize: '2rem', marginRight: '1rem'}}>‚ö†Ô∏è</span>
                                    <h3 style={{margin: 0, fontSize: '1.5rem', fontWeight: '700'}}>
                                        Delete Project
                                    </h3>
                                </div>
                                
                                <div style={{marginBottom: '1.5rem'}}>
                                    <p style={{
                                        marginBottom: '1rem',
                                        color: 'var(--text-primary)',
                                        lineHeight: '1.6'
                                    }}>
                                        You are about to permanently delete the project <strong>{deletingProject.name}</strong>.
                                    </p>
                                    <div style={{
                                        background: 'var(--bg-secondary)',
                                        border: '1px solid var(--border-light)',
                                        borderRadius: 'var(--radius-md)',
                                        padding: '1rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <p style={{margin: '0 0 0.5rem 0', fontWeight: '600', color: 'var(--error)'}}>
                                            This action will permanently delete:
                                        </p>
                                        <ul style={{margin: '0', paddingLeft: '1.5rem', color: 'var(--text-secondary)'}}>
                                            <li>The project configuration</li>
                                            <li>All test runs associated with this project</li>
                                            <li>All test suites and specifications</li>
                                            <li>All historical test data</li>
                                        </ul>
                                    </div>
                                    <p style={{
                                        margin: '0',
                                        color: 'var(--text-secondary)',
                                        fontStyle: 'italic',
                                        fontSize: '0.875rem'
                                    }}>
                                        This action cannot be undone.
                                    </p>
                                </div>

                                <div style={{marginBottom: '1.5rem'}}>
                                    <label style={{
                                        display: 'block',
                                        marginBottom: '0.5rem',
                                        fontWeight: '500',
                                        color: 'var(--text-primary)'
                                    }}>
                                        To confirm deletion, type the project name: <strong style={{color: 'var(--error)'}}>{deletingProject.name}</strong>
                                    </label>
                                    <input
                                        type="text"
                                        value={deleteConfirmInput}
                                        onChange={(e) => setDeleteConfirmInput(e.target.value)}
                                        placeholder="Type project name to confirm"
                                        autoFocus
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem',
                                            border: '2px solid var(--error)',
                                            borderRadius: 'var(--radius-md)',
                                            background: 'var(--bg-secondary)',
                                            color: 'var(--text-primary)',
                                            fontSize: '1rem'
                                        }}
                                    />
                                </div>

                                <div style={{
                                    display: 'flex',
                                    gap: '1rem',
                                    justifyContent: 'flex-end'
                                }}>
                                    <button
                                        onClick={() => {
                                            setDeletingProject(null);
                                            setDeleteConfirmInput('');
                                        }}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: 'var(--radius-md)',
                                            background: 'var(--bg-secondary)',
                                            color: 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontWeight: '600',
                                            transition: 'all 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.target.style.background = 'var(--bg-elevated)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.target.style.background = 'var(--bg-secondary)';
                                        }}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmDeleteProject}
                                        disabled={deleteConfirmInput !== deletingProject.name}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            border: 'none',
                                            borderRadius: 'var(--radius-md)',
                                            background: deleteConfirmInput === deletingProject.name ? 'var(--error)' : 'var(--text-tertiary)',
                                            color: 'white',
                                            cursor: deleteConfirmInput === deletingProject.name ? 'pointer' : 'not-allowed',
                                            fontWeight: '600',
                                            transition: 'all 0.2s ease',
                                            opacity: deleteConfirmInput === deletingProject.name ? 1 : 0.5
                                        }}
                                        onMouseEnter={(e) => {
                                            if (deleteConfirmInput === deletingProject.name) {
                                                e.target.style.background = '#c53030';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (deleteConfirmInput === deletingProject.name) {
                                                e.target.style.background = 'var(--error)';
                                            }
                                        }}
                                    >
                                        Delete Project
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Project Modal Component
        function ProjectModal({ project, teams, isAdmin, onSubmit, onClose }) {
            const [formData, setFormData] = useState({
                name: project?.name || '',
                description: project?.description || '',
                team: project?.team || (teams.length > 0 ? teams[0] : ''),
                repository: project?.repository || '',
                defaultBranch: project?.defaultBranch || 'main'
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name.trim()) {
                    alert('Project name is required');
                    return;
                }
                onSubmit(formData);
            };

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        background: 'var(--bg-primary)',
                        borderRadius: 'var(--radius-xl)',
                        padding: '2rem',
                        maxWidth: '500px',
                        width: '90%',
                        maxHeight: '90vh',
                        overflow: 'auto',
                        boxShadow: 'var(--shadow-xl)'
                    }}>
                        <h3 style={{marginBottom: '1.5rem'}}>
                            {project ? 'Edit Project' : 'Create New Project'}
                        </h3>
                        
                        <form onSubmit={handleSubmit}>
                            <div style={{marginBottom: '1rem'}}>
                                <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>
                                    Project Name *
                                </label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="My Project"
                                    required
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'var(--bg-secondary)',
                                        color: 'var(--text-primary)'
                                    }}
                                />
                            </div>
                            
                            <div style={{marginBottom: '1rem'}}>
                                <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>
                                    Description
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Project description..."
                                    rows={3}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'var(--bg-secondary)',
                                        color: 'var(--text-primary)',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>
                            
                            <div style={{marginBottom: '1rem'}}>
                                <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>
                                    Team
                                </label>
                                <select
                                    value={formData.team}
                                    onChange={(e) => setFormData({...formData, team: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'var(--bg-secondary)',
                                        color: 'var(--text-primary)'
                                    }}
                                >
                                    {isAdmin && <option value="">No team</option>}
                                    {teams.map(team => (
                                        <option key={team} value={team}>{team}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div style={{marginBottom: '1rem'}}>
                                <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>
                                    Repository URL
                                </label>
                                <input
                                    type="text"
                                    value={formData.repository}
                                    onChange={(e) => setFormData({...formData, repository: e.target.value})}
                                    placeholder="https://github.com/org/repo"
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'var(--bg-secondary)',
                                        color: 'var(--text-primary)'
                                    }}
                                />
                            </div>
                            
                            <div style={{marginBottom: '1.5rem'}}>
                                <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>
                                    Default Branch
                                </label>
                                <input
                                    type="text"
                                    value={formData.defaultBranch}
                                    onChange={(e) => setFormData({...formData, defaultBranch: e.target.value})}
                                    placeholder="main"
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'var(--bg-secondary)',
                                        color: 'var(--text-primary)'
                                    }}
                                />
                            </div>
                            
                            <div style={{display: 'flex', gap: '0.75rem', justifyContent: 'flex-end'}}>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    style={{
                                        padding: '0.75rem 1.5rem',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'transparent',
                                        color: 'var(--text-primary)',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    style={{
                                        padding: '0.75rem 1.5rem',
                                        border: 'none',
                                        borderRadius: 'var(--radius-md)',
                                        background: 'var(--primary)',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontWeight: '600'
                                    }}
                                >
                                    {project ? 'Update' : 'Create'} Project
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Main App component
        function FernPlatform() {
            const { route, navigate } = useRouter();
            const [appData, setAppData] = useState({ health: null, projects: [], testRuns: [] });
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => {
                fetchAppData();
            }, []);

            const fetchAppData = async () => {
                try {
                    const data = await graphqlClient.query(GRAPHQL_QUERIES.GET_DASHBOARD_DATA);
                    
                    // Convert projects from edges format
                    const projectList = data.projects.edges.map(edge => edge.node);
                    
                    setAppData({
                        health: data.dashboardSummary.health,
                        projects: projectList,
                        testRuns: data.recentTestRuns || []
                    });
                } catch (err) {
                    console.error('Failed to fetch app data:', err);
                }
            };

            const renderPage = () => {
                const { user, isAdmin, isManager } = useAuth();
                
                switch (route) {
                    case '/test-summaries':
                        return <TestSummaries />;
                    case '/test-runs':
                        return <TestRuns />;
                    case '/manager-dashboard':
                        return (isManager || isAdmin) ? <ManagerDashboard /> : <AccessDenied />;
                    case '/projects':
                        return user ? <ProjectManagement /> : <AccessDenied />;
                    
                    // Admin routes - require admin access
                    case '/admin/users':
                        return isAdmin ? <AdminUsers /> : <AccessDenied />;
                    case '/admin/projects':
                        return isAdmin ? <AdminProjects /> : <AccessDenied />;
                    case '/admin/system':
                        return isAdmin ? <AdminSystem /> : <AccessDenied />;
                    
                    default:
                        return <Dashboard />;
                }
            };

            const handleOpenSettings = () => {
                setShowSettings(true);
            };

            const handleCloseSettings = () => {
                setShowSettings(false);
            };

            return (
                <div>
                    <Header {...appData} onOpenSettings={handleOpenSettings} />
                    <Navigation route={route} navigate={navigate} />
                    {renderPage()}
                    <SettingsPanel 
                        isOpen={showSettings} 
                        onClose={handleCloseSettings}
                        projects={appData.projects}
                    />
                </div>
            );
        }

        // Use React 18's createRoot API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FernPlatform />);
    </script>
</body>
</html>