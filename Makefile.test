# Fern Platform - Testing Makefile
# Handles all testing workflows using Dagger where appropriate

.PHONY: test test-unit test-acceptance test-playwright coverage fmt lint vet

# Test targets
test: test-unit ## Run unit tests (default)

test-unit: ## Run unit tests (excluding e2e tests) 
	@echo "ğŸ§ª Running unit tests..."
	go run github.com/onsi/ginkgo/v2/ginkgo -v -race --cover --coverprofile=coverage.out --label-filter="!e2e" ./...
	@echo "âœ… Unit tests completed"

test-acceptance: ## Run acceptance tests (e2e labeled tests)
	@echo "ğŸ§ª Running acceptance tests..."
	go run github.com/onsi/ginkgo/v2/ginkgo -v --label-filter="e2e" ./...
	@echo "âœ… Acceptance tests completed"

test-playwright: ## Run Playwright tests via Dagger (no k8s required)
	@echo "ğŸ§ª Running Playwright tests via Dagger..."
	cd ci && dagger call acceptance-test-playwright --source=..
	@echo "âœ… Playwright tests completed"

coverage: test-unit ## Generate test coverage report
	@echo "ğŸ“Š Generating coverage report..."
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

# Code quality
fmt: ## Format Go code
	@echo "ğŸ¨ Formatting Go code..."
	go fmt ./...
	@echo "âœ… Code formatted"

lint: ## Run Go linting via Dagger
	@echo "ğŸ” Running linting via Dagger..."
	cd ci && dagger call lint --source=..
	@echo "âœ… Linting completed"

vet: ## Run Go vet
	@echo "ğŸ” Running go vet..."
	go vet ./...
	@echo "âœ… Go vet completed"