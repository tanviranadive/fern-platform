# Fern Platform - Docker Makefile
# Handles container building and operations using Dagger

.PHONY: docker-build docker-run docker-scan docker-push

# Docker operations
docker-build: ## Build Docker image via Dagger 
	@echo "ğŸ³ Building Docker image via Dagger..."
	cd ci && dagger call build --source=..
	@echo "âœ… Docker image built"

docker-run: ## Run Docker container locally
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8080:8080 fern-platform:latest

docker-scan: ## Security scan container via Dagger
	@echo "ğŸ” Running security scan via Dagger..."
	cd ci && dagger call security-scan --source=..
	@echo "âœ… Security scan completed"

docker-push: ## Build and push container images via Dagger
	@echo "ğŸ³ Building and pushing images via Dagger..."
	@if [ -z "$(REGISTRY)" ]; then \
		echo "âŒ REGISTRY environment variable required"; \
		echo "Usage: make docker-push REGISTRY=your-registry.com/fern-platform"; \
		exit 1; \
	fi
	cd ci && dagger call publish \
		--source=.. \
		--registry=$(REGISTRY) \
		--tag=$(VERSION) \
		--username=$(DOCKER_USERNAME) \
		--password=env:DOCKER_PASSWORD
	@echo "âœ… Images pushed to $(REGISTRY)"